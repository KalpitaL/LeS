CREATE TABLE [dbo].[LES_MODULE_ACCESS](
	[MODULEACCESSID] [int] IDENTITY(100000,1) NOT NULL,
	[MODULEACTIONID] [int] NULL,
	[EXT_USERID] [int] NULL,
	[ACCESS_LEVEL] [int] NULL,
	[EXPORTED] [int] NULL,
	[CREATED_DATE] [datetime] NULL,
	[CREATED_BY] [int] NULL,
	[UPDATE_SITE] [int] NULL,
	[UPDATE_DATE] [datetime] NULL,
	[UPDATED_BY] [int] NULL,
 CONSTRAINT [PK_SM_MODULE_ACCESS] PRIMARY KEY CLUSTERED 
(
	[MODULEACCESSID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]

GO


CREATE TABLE [dbo].[LES_SALESORDER](
	[SALESORDERID] [int] IDENTITY(100000,1) NOT NULL,
	[SALESORDERNO] [nvarchar](50) NULL,
	[CUSTOMERID] [int] NULL,
	[STATUS] [int] NULL,
	[CURRENCYID] [int] NULL,
	[BUYERREF] [nvarchar](30) NULL,
	[SHIPNAME] [nvarchar](50) NULL,
	[RFQ_DEL_DATE] [datetime] NULL,
	[DELIVERY_DAYS] [int] NULL,
	[DISCOUNT] [float] NULL,
	[SUPPLIER_REMARKS] [ntext] NULL,
	[PAY_TERMS] [ntext] NULL,
	[GENERAL_TERMS] [ntext] NULL,
	[PROFITMARGIN] [float] NULL,
	[AMOUNT] [float] NULL,
	[FREIGHTAMT] [float] NULL,
	[OTHERCOSTS] [float] NULL,
	[QUOTE_REFERENCE] [nvarchar](30) NULL,
	[QUOTE_VALIDITY] [datetime] NULL,
	[QUOTE_SUBJECT] [nvarchar](100) NULL,
	[QUOTATIONID] [int] NULL,
	[UPDATE_DATE] [datetime] NULL,
	[CREATED_DATE] [datetime] NULL,
	[UPDATED_BY] [int] NULL,
	[CREATED_BY] [int] NULL,
	[ITEM_TOTAL] [float] NULL,
	[SALES_DOC_TYPE] [nvarchar](50) NULL,
 CONSTRAINT [PK_LES_SALESORDER] PRIMARY KEY CLUSTERED 
(
	[SALESORDERID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

ALTER TABLE [dbo].[LES_SALESORDER]  WITH CHECK ADD FOREIGN KEY([CURRENCYID])
REFERENCES [dbo].[SM_CURRENCY] ([CURRENCYID])
GO

ALTER TABLE [dbo].[LES_SALESORDER]  WITH CHECK ADD FOREIGN KEY([CURRENCYID])
REFERENCES [dbo].[SM_CURRENCY] ([CURRENCYID])
GO

ALTER TABLE [dbo].[LES_SALESORDER]  WITH CHECK ADD FOREIGN KEY([QUOTATIONID])
REFERENCES [dbo].[SM_QUOTATIONS_VENDOR] ([QUOTATIONID])
GO

CREATE TABLE [dbo].[LES_SALESORDER_DETAILS](
	[SALESORDERDETAILID] [int] IDENTITY(100000,1) NOT NULL,
	[SALESORDERID] [int] NULL,
	[INVENTORYID] [int] NULL,
	[ITEMNO] [nvarchar](20) NULL,
	[PARTNAME] [nvarchar](1000) NULL,
	[DRAWINGNO] [nvarchar](200) NULL,
	[POSNO] [nvarchar](200) NULL,
	[REFNO] [nvarchar](200) NULL,
	[VENDOR_UNITPRICE] [float] NULL,
	[BUYER_UNITPRICE] [float] NULL,
	[STOCKINHAND] [float] NULL,
	[MAKERREF] [nvarchar](50) NULL,
	[ORDERED_QTY] [float] NULL,
	[QTY] [float] NULL,
	[DISCOUNT] [float] NULL,
	[BUYERUNITID] [int] NULL,
	[SUPPLIERUNITID] [int] NULL,
	[CONVERSION_FACTOR] [int] NULL,
	[STOCKABLE] [int] NULL,
	[TOSPLIT] [int] NULL,
	[UDF1] [nvarchar](50) NULL,
	[UDF2] [nvarchar](50) NULL,
	[UDF3] [nvarchar](50) NULL,
	[QUOTATIONDETAILID] [int] NULL,
	[DELIVERY_DAYS] [int] NULL,
	[ITEM_REMARKS] [ntext] NULL,
	[PROFITMARGIN] [float] NULL,
	[PCK_UNITID] [int] NULL,
	[PACK_QTY] [float] NULL,
	[UPDATE_DATE] [datetime] NULL,
	[CREATED_DATE] [datetime] NULL,
	[UPDATED_BY] [int] NULL,
	[CREATED_BY] [int] NULL,
	[QTD_STOCK] [float] NULL,
	[BUYER_STATUS] [int] NULL,
	[UNIT_CODE] [nvarchar](15) NULL,
	[SS_QUOTATIONDETAILID] [int] NULL,
	[APPROVED_VENDORID] [int] NULL,
	[VENDOR_REFNO] [nvarchar](200) NULL,
 CONSTRAINT [PK_LES_SALESORDER_DETAILS] PRIMARY KEY CLUSTERED 
(
	[SALESORDERDETAILID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([APPROVED_VENDORID])
REFERENCES [dbo].[SM_ADDRESS] ([ADDRESSID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([INVENTORYID])
REFERENCES [dbo].[LES_INVENTORY] ([INVENTORYID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([INVENTORYID])
REFERENCES [dbo].[LES_INVENTORY] ([INVENTORYID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([QUOTATIONDETAILID])
REFERENCES [dbo].[SM_QUOTATIONDETAIL_VENDOR] ([QUOTATIONDETAILID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([QUOTATIONDETAILID])
REFERENCES [dbo].[SM_QUOTATIONDETAIL_VENDOR] ([QUOTATIONDETAILID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([SALESORDERID])
REFERENCES [dbo].[LES_SALESORDER] ([SALESORDERID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([SALESORDERID])
REFERENCES [dbo].[LES_SALESORDER] ([SALESORDERID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([SS_QUOTATIONDETAILID])
REFERENCES [dbo].[SM_QUOTATIONDETAIL_BUYER] ([QUOTATIONDETAILID])
GO

ALTER TABLE [dbo].[LES_SALESORDER_DETAILS]  WITH CHECK ADD FOREIGN KEY([SS_QUOTATIONDETAILID])
REFERENCES [dbo].[SM_QUOTATIONDETAIL_BUYER] ([QUOTATIONDETAILID])
GO



CREATE TABLE [dbo].[SM_QUOTATIONS_BUYER](
	[QUOTATIONID] [int] IDENTITY(100000,1) NOT NULL,
	[DOC_XML] [nvarchar](5) NULL,
	[DOCID] [nvarchar](256) NULL,
	[DOC_TYPE] [nvarchar](50) NULL,
	[VRNO] [nvarchar](50) NULL,
	[BUYER_VRNO] [nvarchar](50) NULL,
	[SUPPLIER_VRNO] [nvarchar](50) NULL,
	[QUOTE_ADDRESSID] [int] NULL,
	[BUYER_ADDRESSID] [int] NULL,
	[RFQ_SENT_DATE] [datetime] NULL,
	[QUOTE_RECVD_DATE] [datetime] NULL,
	[CURRENCYID] [int] NULL,
	[CURR_CODE] [nvarchar](3) NULL,
	[QUOTE_AMOUNT] [float] NULL,
	[QUOTE_EXCHRATE] [float] NULL,
	[ITEM_TOTAL] [float] NULL,
	[OTHERCOSTS] [float] NULL,
	[FREIGHTAMT] [float] NULL,
	[PAYMENT_TERMS] [int] NULL,
	[QUOTE_DISCOUNT] [float] NULL,
	[ADDITIONAL_DISC] [float] NULL,
	[ADD_DISC_TYPE] [tinyint] NULL,
	[QUOTE_VALIDITY] [datetime] NULL,
	[QUOTE_REMARKS] [nvarchar](max) NULL,
	[UPDATE_DATE] [datetime] NULL,
	[DELIVERYTIME] [datetime] NULL,
	[PAYLOADID] [nvarchar](100) NULL,
	[CREATED_DATE] [datetime] NULL,
	[SITEID] [int] NULL,
	[SENT_BY] [int] NULL,
	[PORT_CODE] [nvarchar](15) NULL,
	[PORT_NAME] [nvarchar](100) NULL,
	[QUOTE_APPROVEDDATE] [datetime] NULL,
	[DELIVERYDAYS] [int] NULL,
	[QUOTE_SUBMIT_BY] [int] NULL,
	[QUOTE_REFERENCE] [nvarchar](100) NULL,
	[REPLY_BY_DATE] [datetime] NULL,
	[QUOTE_SUBMIT_DATE] [datetime] NULL,
	[VENDOR_STATUS] [int] NULL,
	[CHANGED_BY_VENDOR] [tinyint] NULL,
	[LATEDATE] [datetime] NULL,
	[RFQ_ACK_DATE] [datetime] NULL,
	[PO_ACK_DATE] [datetime] NULL,
	[POC_REFERENCE] [nvarchar](30) NULL,
	[PODATE] [datetime] NULL,
	[POC_DATE] [datetime] NULL,
	[POC_BY] [int] NULL,
	[BUYER_REMARKS] [nvarchar](max) NULL,
	[VESSEL_NAME] [nvarchar](100) NULL,
	[VESSEL_IDNO] [nvarchar](100) NULL,
	[VESSEL_OWNER] [nvarchar](150) NULL,
	[VESSEL_OWNER_CODE] [nvarchar](50) NULL,
	[EXPORTED] [smallint] NULL,
	[VERSION] [tinyint] NULL,
	[RFQ_EXPORT] [tinyint] NULL,
	[QUOTE_FILE_REF] [nvarchar](150) NULL,
	[PRINT_STATUS] [int] NULL,
	[QUOTE_FILE_STAMP] [nvarchar](50) NULL,
	[DELIVERY_PROMISED] [datetime] NULL,
	[GENERAL_TERMS] [nvarchar](100) NULL,
	[PAY_TERMS] [nvarchar](100) NULL,
	[TAX_PERCNT] [float] NULL,
	[QUOTE_VERSION] [int] NULL,
	[IS_DECLINED] [int] NULL,
	[QUOTE_SUBJECT] [nvarchar](100) NULL,
	[SP_MAS_REMARK] [nvarchar](500) NULL,
	[BYR_SUPP_LINKID] [int] NULL,
	[ATTACHMENT1] [nvarchar](150) NULL,
	[ATTACHMENT2] [nvarchar](150) NULL,
	[ALLOWANCE] [float] NULL,
	[SALESORDERID] [int] NULL,
	[UDF1] [nvarchar](50) NULL,
	[UDF2] [nvarchar](50) NULL,
	[UDF3] [nvarchar](50) NULL,
	[RevisionNumber] [nvarchar](50) NULL,
	[LINK_RECORDID] [int] NULL,
	[TRANSPORT_MODE] [nvarchar](20) NULL,
	[OrderHandling] [nvarchar](50) NULL,
	[OrderType] [nvarchar](50) NULL,
	[OriginatingRequestNo] [nvarchar](50) NULL,
	[ShipComplete] [nvarchar](20) NULL,
	[SupplierORGRef] [nvarchar](50) NULL,
	[UpdType] [nvarchar](50) NULL,
	[ContractType] [nvarchar](50) NULL,
	[OrgSystemRef] [nvarchar](100) NULL,
	[OTHER_COST2] [float] NULL,
	[OTHER_COST3] [float] NULL,
	[VESSEL_ARRTIME] [nvarchar](15) NULL,
	[VESSEL_ETA] [datetime] NULL,
	[QUOTE_STATUS] [int] NULL,
 CONSTRAINT [PK_SM_QUOTATIONS_BUYER] PRIMARY KEY CLUSTERED 
(
	[QUOTATIONID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_QUOTE_AMOUNT]  DEFAULT ((0)) FOR [QUOTE_AMOUNT]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_QUOTE_EXCHRATE]  DEFAULT ((1)) FOR [QUOTE_EXCHRATE]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_ITEM_TOTAL]  DEFAULT ((0)) FOR [ITEM_TOTAL]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_OTHERCOSTS]  DEFAULT ((0)) FOR [OTHERCOSTS]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_FREIGHTAMT]  DEFAULT ((0)) FOR [FREIGHTAMT]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_QUOTE_DISCOUNT]  DEFAULT ((0)) FOR [QUOTE_DISCOUNT]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_VENDOR_STATUS]  DEFAULT ((0)) FOR [VENDOR_STATUS]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONS_BUYER_IS_DECLINED]  DEFAULT ((0)) FOR [IS_DECLINED]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  DEFAULT ((0)) FOR [OTHER_COST2]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] ADD  DEFAULT ((0)) FOR [OTHER_COST3]
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER]  WITH CHECK ADD  CONSTRAINT [FK_SM_QUOTATIONS_BUYER_SM_BUYER_SUPPLIER_LINK] FOREIGN KEY([BYR_SUPP_LINKID])
REFERENCES [dbo].[SM_BUYER_SUPPLIER_LINK] ([LINKID])
GO

ALTER TABLE [dbo].[SM_QUOTATIONS_BUYER] CHECK CONSTRAINT [FK_SM_QUOTATIONS_BUYER_SM_BUYER_SUPPLIER_LINK]
GO




CREATE TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER](
	[QUOTATIONDETAILID] [int] IDENTITY(100000,1) NOT NULL,
	[QUOTATIONID] [int] NULL,
	[ITEMSTATUS] [int] NULL,
	[ITEMNO] [int] NULL,
	[VENDOR_ITEMNO] [nvarchar](20) NULL,
	[QTY_REQ] [float] NULL,
	[QTY_QUOTED] [float] NULL,
	[QTY_ORD] [float] NULL,
	[QUOTED_PRICE] [float] NULL,
	[QUOTE_EXCHRATE] [float] NULL,
	[DISCOUNT] [float] NULL,
	[DELIVERYTIME] [int] NULL,
	[PARTNAME] [nvarchar](1000) NULL,
	[DRAWINGNO] [nvarchar](200) NULL,
	[POSNO] [nvarchar](200) NULL,
	[REFNO] [nvarchar](200) NULL,
	[UNIT_CODE] [nvarchar](15) NULL,
	[EQUIP_NAME] [nvarchar](200) NULL,
	[EQUIP_MAKER] [nvarchar](512) NULL,
	[EQUIP_TYPE] [nvarchar](200) NULL,
	[EQUIP_SERNO] [nvarchar](200) NULL,
	[EQUIP_REMARKS] [nvarchar](1000) NULL,
	[QUOTEITEM_REMARK] [ntext] NULL,
	[ITEM_REMARK] [nvarchar](2048) NULL,
	[UPDATE_DATE] [datetime] NULL,
	[CREATED_DATE] [datetime] NULL,
	[CHANGED_BY_VENDOR] [int] NULL,
	[SITEID] [int] NULL,
	[DOCITEMID] [nvarchar](256) NULL,
	[QUOTE_FILE] [nvarchar](50) NULL,
	[VENDOR_REFNO] [nvarchar](50) NULL,
	[ORIGINATINGSYSTEMREF] [nvarchar](50) NULL,
	[ITEM_MARKED_REMARK] [nvarchar](max) NULL,
	[SYS_ITEMNO] [int] NULL,
	[BUYER_UNIT_CODE] [nvarchar](15) NULL,
	[ITEM_TYPE] [nvarchar](20) NULL,
	[LINK_RECORD_ID] [int] NULL,
	[UDF1] [nvarchar](50) NULL,
	[UDF2] [nvarchar](50) NULL,
	[UDF3] [nvarchar](50) NULL,
	[SupplierORGRef] [nvarchar](20) NULL,
	[SALESORDERID] [int] NULL,
	[SALESORDERITEMID] [int] NULL,
	[VENDOR_ITEMNAME] [nvarchar](500) NULL,
	[BuyerORGRef] [nvarchar](40) NULL,
 CONSTRAINT [PK_SM_QUOTATIONDETAIL_BUYER] PRIMARY KEY NONCLUSTERED 
(
	[QUOTATIONDETAILID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, FILLFACTOR = 90) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_ITEMSTATUS]  DEFAULT ((1)) FOR [ITEMSTATUS]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_QTY_REQ]  DEFAULT ((0)) FOR [QTY_REQ]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_QTY_QUOTED]  DEFAULT ((0)) FOR [QTY_QUOTED]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_QTY_ORD]  DEFAULT ((0)) FOR [QTY_ORD]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_QUOTED_PRICE]  DEFAULT ((0)) FOR [QUOTED_PRICE]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_QUOTE_EXCHRATE]  DEFAULT ((1)) FOR [QUOTE_EXCHRATE]
GO

ALTER TABLE [dbo].[SM_QUOTATIONDETAIL_BUYER] ADD  CONSTRAINT [DF_SM_QUOTATIONDETAIL_BUYER_DISCOUNT]  DEFAULT ((0)) FOR [DISCOUNT]
GO









CREATE PROCEDURE [dbo].[select_SM_TOP_SALESTRANSACTIONS]
(
@ADDRESSID int
)
AS
BEGIN
SELECT TOP (500) SM_QUOTATIONS_VENDOR.QUOTATIONID,LES_SALESORDER.SALESORDERID,VRNO,BUYER_CODE,BUYER_NAME,CHILDCOUNT,
LES_SALESORDER.SALES_DOC_TYPE,LES_SALESORDER.QUOTE_REFERENCE,
CASE WHEN STATUS = 0 THEN 'Initial'   WHEN STATUS = 1 THEN 'Sent to SubSupplier'  WHEN STATUS = 2 THEN 'Waiting for response'  WHEN STATUS = 3 THEN 'Waiting for approval'  WHEN STATUS = 4 THEN 'Ready to export'  WHEN STATUS = 6 THEN 'Completed'   END AS DOCUMENT_STATUS,  
RIGHT('0'+CAST(DATEPART(D,LES_SALESORDER.CREATED_DATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,LES_SALESORDER.CREATED_DATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,LES_SALESORDER.CREATED_DATE) AS VARCHAR) AS CREATED_DATE, 
CURR_CODE,   
SALESORDERNO,
PORT_NAME,VESSEL_NAME, VESSEL_IDNO,QUOTE_ADDRESSID,BUYER_ADDRESSID,LES_SALESORDER.UPDATE_DATE
FROM SM_QUOTATIONS_VENDOR  
INNER JOIN SMV_BUYER_SUPPLIER_LINK ON SM_QUOTATIONS_VENDOR.BYR_SUPP_LINKID=SMV_BUYER_SUPPLIER_LINK.LINKID
INNER JOIN LES_SALESORDER ON SM_QUOTATIONS_VENDOR.QUOTATIONID = LES_SALESORDER.QUOTATIONID
LEFT JOIN LESV_SALESTRANSACTIONCOUNT on	LESV_SALESTRANSACTIONCOUNT.SALESORDERID = LES_SALESORDER.SALESORDERID	
WHERE 
QUOTE_ADDRESSID=@ADDRESSID
ORDER BY LES_SALESORDER.UPDATE_DATE DESC
END
GO


CREATE VIEW [dbo].[LESV_SALESTRANSACTIONCOUNT] as 
SELECT SM_QUOTATIONS_BUYER.SALESORDERID,
COUNT(SM_QUOTATIONS_BUYER.SALESORDERID) AS CHILDCOUNT
FROM dbo.LES_SALESORDER LEFT OUTER JOIN dbo.SM_QUOTATIONS_BUYER 
ON SM_QUOTATIONS_BUYER.SALESORDERID = LES_SALESORDER.SALESORDERID
GROUP BY SM_QUOTATIONS_BUYER.SALESORDERID
GO


CREATE PROCEDURE [dbo].[sp_LES_SALESORDER_Insert]
(
@SALESORDERID int OUTPUT,
@SALESORDERNO nvarchar(50),
@CUSTOMERID int,
@STATUS int,
@SALES_DOC_TYPE NVARCHAR(50),
@CURRENCYID int,
@BUYERREF nvarchar(30),
@SHIPNAME nvarchar(50),
@RFQ_DEL_DATE datetime,
@DELIVERY_DAYS int,
@DISCOUNT float,
@SUPPLIER_REMARKS ntext,
@PAY_TERMS ntext,
@GENERAL_TERMS ntext,
@PROFITMARGIN float,
@AMOUNT float,
@FREIGHTAMT float,
@OTHERCOSTS float,
@QUOTE_REFERENCE nvarchar(30),
@QUOTE_VALIDITY datetime,
@QUOTE_SUBJECT nvarchar(100),
@QUOTATIONID int,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@ITEM_TOTAL float
)
AS
BEGIN

INSERT INTO [dbo].[LES_SALESORDER]
(
[SALESORDERNO],
[CUSTOMERID],
[STATUS],
[SALES_DOC_TYPE],
[CURRENCYID],
[BUYERREF],
[SHIPNAME],
[RFQ_DEL_DATE],
[DELIVERY_DAYS],
[DISCOUNT],
[SUPPLIER_REMARKS],
[PAY_TERMS],
[GENERAL_TERMS],
[PROFITMARGIN],
[AMOUNT],
[FREIGHTAMT],
[OTHERCOSTS],
[QUOTE_REFERENCE],
[QUOTE_VALIDITY],
[QUOTE_SUBJECT],
[QUOTATIONID],
[UPDATE_DATE],
[CREATED_DATE],
[UPDATED_BY],
[CREATED_BY],
[ITEM_TOTAL]
)
VALUES
(
@SALESORDERNO,
@CUSTOMERID,
@STATUS,
@SALES_DOC_TYPE,
@CURRENCYID,
@BUYERREF,
@SHIPNAME,
@RFQ_DEL_DATE,
@DELIVERY_DAYS,
@DISCOUNT,
@SUPPLIER_REMARKS,
@PAY_TERMS,
@GENERAL_TERMS,
@PROFITMARGIN,
@AMOUNT,
@FREIGHTAMT,
@OTHERCOSTS,
@QUOTE_REFERENCE,
@QUOTE_VALIDITY,
@QUOTE_SUBJECT,
@QUOTATIONID,
@UPDATE_DATE,
@CREATED_DATE,
@UPDATED_BY,
@CREATED_BY,
@ITEM_TOTAL
)

Select @SALESORDERID = scope_identity();

END
GO

DROP PROC sp_LES_SALESORDER_Update_1 -- RENAMED TO sp_LES_SALESORDER_Update_AllFields
GO

CREATE Procedure [dbo].[sp_LES_SALESORDER_Update_AllFields]
(
@SALESORDERID int,
@SALESORDERNO nvarchar(50),
@CUSTOMERID int,
@STATUS int,
@SALES_DOC_TYPE NVARCHAR(50),
@CURRENCYID int,
@BUYERREF nvarchar(30),
@SHIPNAME nvarchar(50),
@RFQ_DEL_DATE datetime,
@DELIVERY_DAYS int,
@DISCOUNT float,
@SUPPLIER_REMARKS  ntext,
@PAY_TERMS  ntext,
@GENERAL_TERMS  ntext,
@PROFITMARGIN float,
@AMOUNT float,
@FREIGHTAMT float,
@OTHERCOSTS float,
@QUOTE_REFERENCE nvarchar(30),
@QUOTE_VALIDITY datetime,
@QUOTE_SUBJECT nvarchar(100),
@QUOTATIONID int,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@ITEM_TOTAL float
)
AS
BEGIN
    UPDATE [dbo].[LES_SALESORDER]
    SET
        [SALESORDERNO]=@SALESORDERNO,
        [CUSTOMERID]=@CUSTOMERID,
        [STATUS]=@STATUS,
		[SALES_DOC_TYPE]=@SALES_DOC_TYPE,
        [CURRENCYID]=@CURRENCYID,
        [BUYERREF]=@BUYERREF,
        [SHIPNAME]=@SHIPNAME,
        [RFQ_DEL_DATE]=@RFQ_DEL_DATE,
        [DELIVERY_DAYS]=@DELIVERY_DAYS,
        [DISCOUNT]=@DISCOUNT,
        [SUPPLIER_REMARKS]=@SUPPLIER_REMARKS,
        [PAY_TERMS]=@PAY_TERMS,
        [GENERAL_TERMS]=@GENERAL_TERMS,
        [PROFITMARGIN]=@PROFITMARGIN,
        [AMOUNT]=@AMOUNT,
        [FREIGHTAMT]=@FREIGHTAMT,
        [OTHERCOSTS]=@OTHERCOSTS,
        [QUOTE_REFERENCE]=@QUOTE_REFERENCE,
        [QUOTE_VALIDITY]=@QUOTE_VALIDITY,
        [QUOTE_SUBJECT]=@QUOTE_SUBJECT,
        [QUOTATIONID]=@QUOTATIONID,
        [UPDATE_DATE]=@UPDATE_DATE,
        [CREATED_DATE]=@CREATED_DATE,
        [UPDATED_BY]=@UPDATED_BY,
        [CREATED_BY]=@CREATED_BY,
        [ITEM_TOTAL]=@ITEM_TOTAL
WHERE   [SALESORDERID]=@SALESORDERID
END

GO

CREATE PROCEDURE [dbo].[select_SALESTRANSACTIONS_BY_SALESORDERID]
(
@SALESORDERID int
)
AS
BEGIN
SELECT SM_QUOTATIONS_BUYER.QUOTATIONID,VRNO,B.ADDR_CODE AS BUYER_CODE,B.ADDR_NAME AS BUYER_NAME,S.ADDR_CODE AS SUPPLIER_CODE,
S.ADDR_NAME AS SUPPLIER_NAME,
DOC_TYPE,
RIGHT('0'+CAST(DATEPART(D,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR) AS RFQ_RECEIVED_DATE, 
CASE WHEN UPPER(DOC_TYPE) IN ('QUOTE','QUOTATION','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,RFQ_ACK_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,RFQ_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,RFQ_ACK_DATE) AS VARCHAR) END AS RFQ_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+CAST(DATEPART(YYYY,QUOTE_RECVD_DATE) AS VARCHAR) END AS QUOTE_RECVD_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.FREIGHTAMT END AS FREIGHTAMT,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE QUOTE_AMOUNT END AS QUOTE_AMOUNT,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.OTHERCOSTS END AS OTHERCOSTS,CURR_CODE,   
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE   RIGHT('0'+CAST(DATEPART(D,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR) END AS QUOTE_VALIDITY, 
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.QUOTE_REFERENCE END AS QUOTE_REFERENCE, 		 
RIGHT('0'+CAST(DATEPART(D,PODATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,PODATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,PODATE) AS VARCHAR) AS PODATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,PO_ACK_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,PO_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,PO_ACK_DATE) AS VARCHAR) END AS PO_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,POC_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,POC_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,POC_DATE) AS VARCHAR) END AS POC_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  POC_REFERENCE END AS POC_REFERENCE,
CASE WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=0) THEN 'Draft' 
 WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=1) THEN 'Queued for export' 
 WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=2) THEN 'Sent' ELSE '' END AS SENT_STATUS,
PORT_NAME,VESSEL_NAME, VESSEL_IDNO,QUOTE_ADDRESSID,BUYER_ADDRESSID,SM_QUOTATIONS_BUYER.UPDATE_DATE
FROM SM_QUOTATIONS_BUYER
INNER JOIN LES_SALESORDER ON SM_QUOTATIONS_BUYER.SALESORDERID = LES_SALESORDER.SALESORDERID
LEFT JOIN SM_ADDRESS S ON SM_QUOTATIONS_BUYER.QUOTE_ADDRESSID=S.ADDRESSID  
LEFT JOIN SM_ADDRESS B ON SM_QUOTATIONS_BUYER.BUYER_ADDRESSID=B.ADDRESSID  
WHERE--  YEAR(SM_QUOTATIONS_VENDOR.UPDATE_DATE)= YEAR(GETDATE()) AND 
SM_QUOTATIONS_BUYER.SALESORDERID=@SALESORDERID
--ORDER BY SM_QUOTATIONS_BUYER.UPDATE_DATE DESC
ORDER BY SM_QUOTATIONS_BUYER.QUOTATIONID DESC
END


GO

CREATE PROCEDURE [dbo].[sp_Select_LES_SALESORDERs_By_QUOTATIONID](@QUOTATIONID INT)
AS BEGIN 
SELECT  LES_SALESORDER.SALESORDERID,LES_SALESORDER.SALESORDERNO,LES_SALESORDER.CUSTOMERID,LES_SALESORDER.STATUS,LES_SALESORDER.CURRENCYID,LES_SALESORDER.BUYERREF,LES_SALESORDER.SHIPNAME,
LES_SALESORDER.RFQ_DEL_DATE,LES_SALESORDER.DELIVERY_DAYS,LES_SALESORDER.DISCOUNT,LES_SALESORDER.SUPPLIER_REMARKS,LES_SALESORDER.PAY_TERMS,LES_SALESORDER.GENERAL_TERMS,LES_SALESORDER.PROFITMARGIN,LES_SALESORDER.AMOUNT,LES_SALESORDER.ITEM_TOTAL,LES_SALESORDER.FREIGHTAMT,LES_SALESORDER.OTHERCOSTS,LES_SALESORDER.QUOTE_REFERENCE,
LES_SALESORDER.QUOTE_VALIDITY ,LES_SALESORDER.QUOTE_SUBJECT,LES_SALESORDER.QUOTATIONID,LES_SALESORDER.UPDATE_DATE,LES_SALESORDER.CREATED_DATE,LES_SALESORDER.UPDATED_BY,LES_SALESORDER.CREATED_BY,
SM_QUOTATIONS_VENDOR.VESSEL_ETA,LES_SALESORDER.SALES_DOC_TYPE,
BUYER_REMARKS,QUOTE_REMARKS,SM_CURRENCY.CURR_CODE,DOC_TYPE,REPLY_BY_DATE, LATEDATE ,VENDOR_STATUS,
SM_QUOTATIONS_VENDOR.CREATED_DATE AS RFQ_CREATED_DATE,VESSEL_IDNO,VESSEL_NAME,VESSEL_OWNER,VESSEL_OWNER_CODE,PORT_CODE,PORT_NAME FROM [dbo].[LES_SALESORDER]
LEFT JOIN SM_QUOTATIONS_VENDOR ON LES_SALESORDER.QUOTATIONID=SM_QUOTATIONS_VENDOR.QUOTATIONID
LEFT JOIN SM_CURRENCY ON SM_CURRENCY.CURRENCYID=LES_SALESORDER.CURRENCYID WHERE LES_SALESORDER.QUOTATIONID = @QUOTATIONID
END



GO

ALTER TABLE SM_ADDRESS ADD SUB_BUYER_ADDRESSID INT
GO

CREATE PROCEDURE [dbo].[sp_GET_SUBSUPPLIERS]
(
@SUPPLIERID INT
)
AS
BEGIN
SELECT LINKID, S.*, B.ADDR_CODE AS BUYER_CODE,B.ADDR_NAME AS BUYER_NAME FROM 
     [dbo].[SM_ADDRESS] B LEFT JOIN SM_BUYER_SUPPLIER_LINK  ON 
B.ADDRESSID=SM_BUYER_SUPPLIER_LINK.BUYERID 
LEFT JOIN [dbo].[SM_ADDRESS] SB ON SB.SUB_BUYER_ADDRESSID=SM_BUYER_SUPPLIER_LINK.BUYERID
INNER JOIN [dbo].[SM_ADDRESS] S ON S.ADDRESSID=SM_BUYER_SUPPLIER_LINK.SUPPLIERID
where SB.ADDRESSID = @SUPPLIERID AND S.ADDR_TYPE='Supplier'
END
GO



CREATE TABLE [dbo].[SM_QUOTATIONS_BUYER_ADDRESS](
	[ADDRESSID] [int] IDENTITY(100000,1) NOT NULL,
	[QUOTATIONID] [int] NULL,
	[ADDR_TYPE] [varchar](15) NULL,
	[ADDR_CODE] [nvarchar](50) NULL,
	[ADDR_NAME] [nvarchar](150) NULL,
	[CONTACT_PERSON] [nvarchar](50) NULL,
	[ADDRESS1] [nvarchar](512) NULL,
	[ADDRESS2] [nvarchar](512) NULL,
	[ADDRESS3] [nvarchar](512) NULL,
	[ADDRESS4] [nvarchar](512) NULL,
	[ADDR_CITY] [nvarchar](50) NULL,
	[ADDR_COUNTRY] [nvarchar](50) NULL,
	[ADDR_ZIPCODE] [nvarchar](50) NULL,
	[ADDR_PHONE1] [nvarchar](50) NULL,
	[ADDR_PHONE2] [nvarchar](50) NULL,
	[ADDR_FAX] [nvarchar](50) NULL,
	[ADDR_TELEX] [nvarchar](50) NULL,
	[ADDR_EMAIL] [nvarchar](100) NULL,
	[ADDR_MOBILEPHONE] [nvarchar](50) NULL,
	[UPDATE_DATE] [datetime] NULL,
	[ADDR_REMARKS] [nvarchar](2000) NULL,
	[EMAIL_CC] [nvarchar](50) NULL,
	[EMAIL_BCC] [nvarchar](50) NULL,
 CONSTRAINT [PK_SM_QUOTATIONS_BUYER_ADDRESS] PRIMARY KEY CLUSTERED 
(
	[ADDRESSID] ASC
))

GO


CREATE PROCEDURE [dbo].[sp_LES_SALESORDERDETAILS_SALESORDERID]
(
@SALESORDERID INT
)
AS
BEGIN
SELECT SALESORDERDETAILID,SO.SALESORDERID,
SO.QUOTATIONDETAILID,
SO.DRAWINGNO,
SO.POSNO,
SO.MAKERREF,
SO.ITEMNO,
TOSPLIT,
SO.UDF1,
SO.UDF2,
SO.UDF3,
ISNULL(SO.REFNO,'') AS 'REFNO',	
SO.PARTNAME,
SM_QUOTATIONDETAIL_VENDOR.BUYER_UNIT_CODE,	
SO.UNIT_CODE,
ORDERED_QTY,QTY,
BUYER_STATUS,
ISNULL(BUYER_UNITPRICE,0) AS BUYER_UNITPRICE,
ISNULL(VENDOR_UNITPRICE,0) AS VENDOR_UNITPRICE,
ISNULL(SO.DISCOUNT,0) AS DISCOUNT,
ISNULL(DELIVERY_DAYS,0) AS DELIVERY_DAYS,
SO.UPDATE_DATE,
SO.CREATED_DATE,
SO.UPDATED_BY,
SO.CREATED_BY,
(ISNULL(SO.PARTNAME,'') + (case when (SO.REFNO IS NOT NULL OR SO.REFNO<>'') 
then ('|Ref. No. :'+SO.REFNO) else '' end)+	(case when (SO.DRAWINGNO is not null or SO.DRAWINGNO <> '') 
then ('|Drawing No.:'+ SO.DRAWINGNO) else '' end))	AS DISPLAY_PARTNAME,
ITEM_REMARKS,SO.APPROVED_VENDORID 
FROM LES_SALESORDER_DETAILS SO
left join SM_QUOTATIONDETAIL_VENDOR ON SO.QUOTATIONDETAILID=SM_QUOTATIONDETAIL_VENDOR.QUOTATIONDETAILID
WHERE SALESORDERID= @SALESORDERID

END
GO

CREATE PROCEDURE [dbo].[sp_GET_SUPP_SUB_ADDRESSDETAILS](@QUOTATIONID INT) AS
BEGIN
Select DISTINCT B.ADDR_NAME AS BILLTO_ADDRNAME,B.CONTACT_PERSON AS BILLTO_CONTACTPERSON,B.ADDRESS1 AS BILLTO_ADDRESS1,B.ADDRESS2 AS BILLTO_ADDRESS2,
B.ADDRESS3 AS BILLTO_ADDRESS3,B.ADDRESS4 AS BILLTO_ADDRESS4,B.ADDR_COUNTRY AS BILLTO_ADDR_COUNTRY,B.ADDR_PHONE1 AS BILLTO_ADDR_PHONE1,B.ADDR_FAX AS BILLTO_ADDR_FAX,
B.ADDR_EMAIL AS BILLTO_ADDR_EMAIL,B.ADDR_MOBILEPHONE AS BILLTO_ADDR_MOBILEPHONE,
S.ADDR_NAME AS SHIPTO_ADDRNAME,S.CONTACT_PERSON AS SHIPTO_CONTACTPERSON,S.ADDRESS1 AS SHIPTO_ADDRESS1,S.ADDRESS2 AS SHIPTO_ADDRESS2,
S.ADDRESS3 AS SHIPTO_ADDRESS3,S.ADDRESS4 AS SHIPTO_ADDRESS4,S.ADDR_COUNTRY AS SHIPTO_ADDR_COUNTRY,S.ADDR_PHONE1 AS SHIPTO_ADDR_PHONE1,S.ADDR_FAX AS SHIPTO_ADDR_FAX,
S.ADDR_EMAIL AS SHIPTO_ADDR_EMAIL,S.ADDR_MOBILEPHONE AS SHIPTO_ADDR_MOBILEPHONE,
BYR.ADDR_NAME AS BUYER_ADDRNAME,BYR.CONTACT_PERSON AS BUYER_CONTACTPERSON,BYR.ADDRESS1 AS BUYER_ADDRESS1,BYR.ADDRESS2 AS BUYER_ADDRESS2,
BYR.ADDRESS3 AS BUYER_ADDRESS3,BYR.ADDRESS4 AS BUYER_ADDRESS4,BYR.ADDR_COUNTRY AS BUYER_ADDR_COUNTRY,BYR.ADDR_PHONE1 AS BUYER_ADDR_PHONE1,BYR.ADDR_FAX AS BUYER_ADDR_FAX,
BYR.ADDR_EMAIL AS BUYER_ADDR_EMAIL,BYR.ADDR_MOBILEPHONE AS BUYER_ADDR_MOBILEPHONE,
SUPP.ADDR_NAME AS SUPP_ADDRNAME,SUPP.CONTACT_PERSON AS SUPP_CONTACTPERSON,SUPP.ADDRESS1 AS SUPP_ADDRESS1,SUPP.ADDRESS2 AS SUPP_ADDRESS2,
SUPP.ADDRESS3 AS SUPP_ADDRESS3,SUPP.ADDRESS4 AS SUPP_ADDRESS4,SUPP.ADDR_COUNTRY AS SUPP_ADDR_COUNTRY,SUPP.ADDR_PHONE1 AS SUPP_ADDR_PHONE1,SUPP.ADDR_FAX AS SUPP_ADDR_FAX,
SUPP.ADDR_EMAIL AS SUPP_ADDR_EMAIL,SUPP.ADDR_MOBILEPHONE AS SUPP_ADDR_MOBILEPHONE
FROM
(SELECT * FROM SM_QUOTATIONS_BUYER_ADDRESS WHERE QUOTATIONID = @QUOTATIONID) QUOTATION_BUYER_ADDRESS LEFT JOIN 
(SELECT * FROM SM_QUOTATIONS_BUYER_ADDRESS WHERE QUOTATIONID = @QUOTATIONID AND ADDR_TYPE='Vendor') SUPP ON QUOTATION_BUYER_ADDRESS.QUOTATIONID=SUPP.QUOTATIONID  LEFT JOIN 
(SELECT * FROM SM_QUOTATIONS_BUYER_ADDRESS WHERE QUOTATIONID = @QUOTATIONID AND ADDR_TYPE='Buyer') BYR ON SUPP.QUOTATIONID=BYR.QUOTATIONID LEFT JOIN
(SELECT * FROM SM_QUOTATIONS_BUYER_ADDRESS WHERE QUOTATIONID = @QUOTATIONID AND ADDR_TYPE='Bill To') B ON BYR.QUOTATIONID=B.QUOTATIONID LEFT JOIN
(SELECT * FROM SM_QUOTATIONS_BUYER_ADDRESS WHERE QUOTATIONID = @QUOTATIONID AND ADDR_TYPE='Ship To') S  ON BYR.QUOTATIONID=S.QUOTATIONID
END
GO




CREATE Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Update]
(
@ADDRESSID int,
@QUOTATIONID int,
@ADDR_TYPE nvarchar(15),
@ADDR_CODE nvarchar(50),
@ADDR_NAME nvarchar(150),
@CONTACT_PERSON nvarchar(150),
@ADDRESS1 nvarchar(512),
@ADDRESS2 nvarchar(512),
@ADDRESS3 nvarchar(512),
@ADDRESS4 nvarchar(512),
@ADDR_CITY nvarchar(50),
@ADDR_COUNTRY nvarchar(50),
@ADDR_ZIPCODE nvarchar(50),
@ADDR_PHONE1 nvarchar(50),
@ADDR_PHONE2 nvarchar(50),
@ADDR_FAX nvarchar(50),
@ADDR_TELEX nvarchar(50),
@ADDR_EMAIL nvarchar(100),
@ADDR_MOBILEPHONE nvarchar(50),
@UPDATE_DATE datetime,
@ADDR_REMARKS nvarchar(2000),
@EMAIL_CC nvarchar(50),
@EMAIL_BCC nvarchar(50)
)
AS
BEGIN
    UPDATE [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
    SET
        [QUOTATIONID]=@QUOTATIONID,
        [ADDR_TYPE]=@ADDR_TYPE,
        [ADDR_CODE]=@ADDR_CODE,
        [ADDR_NAME]=@ADDR_NAME,
        [CONTACT_PERSON]=@CONTACT_PERSON,
        [ADDRESS1]=@ADDRESS1,
        [ADDRESS2]=@ADDRESS2,
        [ADDRESS3]=@ADDRESS3,
        [ADDRESS4]=@ADDRESS4,
        [ADDR_CITY]=@ADDR_CITY,
        [ADDR_COUNTRY]=@ADDR_COUNTRY,
        [ADDR_ZIPCODE]=@ADDR_ZIPCODE,
        [ADDR_PHONE1]=@ADDR_PHONE1,
        [ADDR_PHONE2]=@ADDR_PHONE2,
        [ADDR_FAX]=@ADDR_FAX,
        [ADDR_TELEX]=@ADDR_TELEX,
        [ADDR_EMAIL]=@ADDR_EMAIL,
        [ADDR_MOBILEPHONE]=@ADDR_MOBILEPHONE,
        [UPDATE_DATE]=@UPDATE_DATE,
        [ADDR_REMARKS]=@ADDR_REMARKS,
        [EMAIL_CC]=@EMAIL_CC,
        [EMAIL_BCC]=@EMAIL_BCC
WHERE        [ADDRESSID]=@ADDRESSID
END
GO


Create Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Select_One]
(
@ADDRESSID int
)
AS
BEGIN
    SELECT [ADDRESSID],[QUOTATIONID],[ADDR_TYPE],[ADDR_CODE],[ADDR_NAME],[CONTACT_PERSON],[ADDRESS1],[ADDRESS2],[ADDRESS3],[ADDRESS4],[ADDR_CITY],[ADDR_COUNTRY],[ADDR_ZIPCODE],[ADDR_PHONE1],[ADDR_PHONE2],[ADDR_FAX],[ADDR_TELEX],[ADDR_EMAIL],[ADDR_MOBILEPHONE],[UPDATE_DATE],[ADDR_REMARKS],[EMAIL_CC],[EMAIL_BCC]
    FROM [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
    WHERE
        [ADDRESSID]=@ADDRESSID
END
GO

CREATE  Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Select_by_QuotationId]
(
@QUOTATIONID int
)
AS
BEGIN
    SELECT * 
    FROM [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
    WHERE
        [QUOTATIONID]=@QUOTATIONID
END
GO




CREATE  Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Select_by_AddressType]
(
@QUOTATIONID int,
@ADDR_TYPE varchar(10)
)

AS
BEGIN
    SELECT *
    FROM [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
WHERE [QUOTATIONID]=@QUOTATIONID AND [ADDR_TYPE]=@ADDR_TYPE
END
GO



CREATE  Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Select_All]
AS
BEGIN
    SELECT * FROM [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
END
GO



CREATE  Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Insert]
(
@QUOTATIONID int,
@ADDR_TYPE nvarchar(15),
@ADDR_CODE nvarchar(50),
@ADDR_NAME nvarchar(150),
@CONTACT_PERSON nvarchar(150),
@ADDRESS1 nvarchar(512),
@ADDRESS2 nvarchar(512),
@ADDRESS3 nvarchar(512),
@ADDRESS4 nvarchar(512),
@ADDR_CITY nvarchar(50),
@ADDR_COUNTRY nvarchar(50),
@ADDR_ZIPCODE nvarchar(50),
@ADDR_PHONE1 nvarchar(50),
@ADDR_PHONE2 nvarchar(50),
@ADDR_FAX nvarchar(50),
@ADDR_TELEX nvarchar(50),
@ADDR_EMAIL nvarchar(100),
@ADDR_MOBILEPHONE nvarchar(50),
@UPDATE_DATE datetime,
@ADDR_REMARKS nvarchar(2000)
)
AS
BEGIN
    INSERT INTO [dbo].[SM_QUOTATIONS_BUYER_ADDRESS]
    (
        [QUOTATIONID],
[ADDR_TYPE],
[ADDR_CODE],
[ADDR_NAME],
[CONTACT_PERSON],
[ADDRESS1],
[ADDRESS2],
[ADDRESS3],
[ADDRESS4],
[ADDR_CITY],
[ADDR_COUNTRY],
[ADDR_ZIPCODE],
[ADDR_PHONE1],
[ADDR_PHONE2],
[ADDR_FAX],
[ADDR_TELEX],
[ADDR_EMAIL],
[ADDR_MOBILEPHONE],
[UPDATE_DATE],
[ADDR_REMARKS]
    )
    VALUES
    (
        @QUOTATIONID,
@ADDR_TYPE,
@ADDR_CODE,
@ADDR_NAME,
@CONTACT_PERSON,
@ADDRESS1,
@ADDRESS2,
@ADDRESS3,
@ADDRESS4,
@ADDR_CITY,
@ADDR_COUNTRY,
@ADDR_ZIPCODE,
@ADDR_PHONE1,
@ADDR_PHONE2,
@ADDR_FAX,
@ADDR_TELEX,
@ADDR_EMAIL,
@ADDR_MOBILEPHONE,
@UPDATE_DATE,
@ADDR_REMARKS

    )
    
	Select scope_identity();
END

GO

CREATE  Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_ADDRESS_Delete]
(
	@ADDRESSID INT
)
As 
BEGIN
	DELETE from SM_QUOTATIONS_BUYER_ADDRESS 
	Where [ADDRESSID]=@ADDRESSID
END
GO


ALTER TABLE [LES_SALESORDER_DETAILS]
ADD APPROVED_VENDORID INT FOREIGN KEY REFERENCES SM_ADDRESS(ADDRESSID)
GO



CREATE PROCEDURE [dbo].[sp_GET_SUBSUPPLIERS_EXQUOTATION]
(
@SUPPLIERID INT,
@SALESORDERID INT
)
AS
BEGIN
SELECT LINKID, S.*, B.ADDR_CODE AS BUYER_CODE,B.ADDR_NAME AS BUYER_NAME,SB.ADDRESSID FROM 
     [dbo].[SM_ADDRESS] B LEFT JOIN SM_BUYER_SUPPLIER_LINK  ON 
B.ADDRESSID=SM_BUYER_SUPPLIER_LINK.BUYERID 
LEFT JOIN [dbo].[SM_ADDRESS] SB ON SB.SUB_BUYER_ADDRESSID=SM_BUYER_SUPPLIER_LINK.BUYERID
INNER JOIN [dbo].[SM_ADDRESS] S ON S.ADDRESSID=SM_BUYER_SUPPLIER_LINK.SUPPLIERID
where SB.ADDRESSID = @SUPPLIERID AND S.ADDR_TYPE='Supplier'
AND S.ADDRESSID NOT IN (SELECT QUOTE_ADDRESSID FROM SM_QUOTATIONS_BUYER WHERE SALESORDERID = @SALESORDERID)

END

GO

CREATE PROCEDURE [dbo].[sp_LES_SALESORDER]
(
@SALESORDERID int
)
AS
BEGIN
SELECT  [LES_SALESORDER].*,BUYER_REMARKS,QUOTE_REMARKS,
SM_CURRENCY.CURR_CODE,DOC_TYPE,REPLY_BY_DATE,LATEDATE,VENDOR_STATUS,
SM_QUOTATIONS_VENDOR.CREATED_DATE AS RFQ_CREATED_DATE,SM_QUOTATIONS_VENDOR.VESSEL_ETA,
VESSEL_IDNO,VESSEL_NAME,VESSEL_OWNER,
VESSEL_OWNER_CODE,PORT_CODE,PORT_NAME,
[VERSION],SM_QUOTATIONS_VENDOR.QUOTE_REFERENCE AS 'VENDOR_QUOTE_REF'
FROM [dbo].[LES_SALESORDER]
LEFT JOIN SM_QUOTATIONS_VENDOR ON LES_SALESORDER.QUOTATIONID=SM_QUOTATIONS_VENDOR.QUOTATIONID
LEFT JOIN SM_CURRENCY ON SM_CURRENCY.CURRENCYID=LES_SALESORDER.CURRENCYID
WHERE [SALESORDERID]=@SALESORDERID

END
GO

-- USED WHEN SPLITING ORDERS FOR SUB SUPPLIERS --
CREATE PROC sp_LES_SALESORDERDETAILS_APPROVED
(
@SALESORDERID INT
)
AS
BEGIN
SELECT * FROM LES_SALESORDER_DETAILS 
WHERE APPROVED_VENDORID IS NOT NULL 
AND SALESORDERID = @SALESORDERID
END

ALTER TABLE LES_SALESORDER_DETAILS ADD VENDOR_REFNO NVARCHAR(200)
go

exec sp_rename 'LES_SALESORDER_DETAILS.BUYER_UNITCODE', 'UNIT_CODE' , 'COLUMN'
go

CREATE PROCEDURE [dbo].[sp_LES_SALESORDER_DETAILS_Insert]
(
@SALESORDERID int,
@INVENTORYID int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@VENDOR_UNITPRICE FLOAT,
@BUYER_UNITPRICE FLOAT,
@STOCKINHAND FLOAT,
@MAKERREF nvarchar(50),
@ORDERED_QTY FLOAT,
@QTY FLOAT,
@DISCOUNT FLOAT,
@BUYERUNITID int,
@UNIT_CODE NVARCHAR(15),
@SUPPLIERUNITID int,
@CONVERSION_FACTOR int,
@STOCKABLE int,
@TOSPLIT int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@QUOTATIONDETAILID int,
@DELIVERY_DAYS int,
@ITEM_REMARKS ntext,
@PROFITMARGIN FLOAT,
@PCK_UNITID int,
@PACK_QTY FLOAT,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@QTD_STOCK FLOAT,
@BUYER_STATUS FLOAT,
@ITEMNO FLOAT,
@APPROVED_VENDORID int
)
AS
BEGIN
    INSERT INTO [dbo].[LES_SALESORDER_DETAILS]
    (
        [SALESORDERID],
[INVENTORYID],
[PARTNAME],
[DRAWINGNO],
[POSNO],
[REFNO],
[VENDOR_UNITPRICE],
[BUYER_UNITPRICE],
[STOCKINHAND],
[MAKERREF],
[ORDERED_QTY],
[QTY],
[DISCOUNT],
[BUYERUNITID],
[UNIT_CODE],
[SUPPLIERUNITID],
[CONVERSION_FACTOR],
[STOCKABLE],
[TOSPLIT],
[UDF1],
[UDF2],
[UDF3],
[QUOTATIONDETAILID],
[DELIVERY_DAYS],
[ITEM_REMARKS],
[PROFITMARGIN],
[PCK_UNITID],
[PACK_QTY],
[UPDATE_DATE],
[CREATED_DATE],
[UPDATED_BY],
[CREATED_BY],
[QTD_STOCK],
[BUYER_STATUS],
[ITEMNO],
[APPROVED_VENDORID]
    )
    VALUES
    (
        @SALESORDERID,
@INVENTORYID,
@PARTNAME,
@DRAWINGNO,
@POSNO,
@REFNO,
@VENDOR_UNITPRICE,
@BUYER_UNITPRICE,
@STOCKINHAND,
@MAKERREF,
@ORDERED_QTY,
@QTY,
@DISCOUNT,
@BUYERUNITID,
@UNIT_CODE,
@SUPPLIERUNITID,
@CONVERSION_FACTOR,
@STOCKABLE,
@TOSPLIT,
@UDF1,
@UDF2,
@UDF3,
@QUOTATIONDETAILID,
@DELIVERY_DAYS,
@ITEM_REMARKS,
@PROFITMARGIN,
@PCK_UNITID,
@PACK_QTY,
@UPDATE_DATE,
@CREATED_DATE,
@UPDATED_BY,
@CREATED_BY,
@QTD_STOCK,
@BUYER_STATUS,
@ITEMNO,
@APPROVED_VENDORID
    )
    Select @@identity;
END

GO

CREATE PROCEDURE [dbo].[sp_LES_SALESORDER_DETAILS_Update_1]
(
@SALESORDERDETAILID int,
@SALESORDERID int,
@ITEMNO nvarchar(20),
@INVENTORYID int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@VENDOR_UNITPRICE float,
@BUYER_UNITPRICE float,
@STOCKINHAND float,
@MAKERREF nvarchar(50),
@ORDERED_QTY float,
@QTY float,
@DISCOUNT float,
@BUYERUNITID int,
@SUPPLIERUNITID int,
@CONVERSION_FACTOR int,
@STOCKABLE int,
@TOSPLIT int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@QUOTATIONDETAILID int,
@DELIVERY_DAYS int,
@ITEM_REMARKS ntext,
@PROFITMARGIN float,
@PCK_UNITID int,
@PACK_QTY float,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@QTD_STOCK float,
@BUYER_STATUS INT,
@UNIT_CODE nvarchar(50),
@APPROVED_VENDORID INT
)
AS
BEGIN
    UPDATE [dbo].[LES_SALESORDER_DETAILS]
    SET
    [SALESORDERID]=@SALESORDERID,
    [ITEMNO]=@ITEMNO,
    [INVENTORYID]=@INVENTORYID,
    [PARTNAME]=@PARTNAME,
    [DRAWINGNO]=@DRAWINGNO,
    [POSNO]=@POSNO,
    [REFNO]=@REFNO,
    [VENDOR_UNITPRICE]=@VENDOR_UNITPRICE,
    [BUYER_UNITPRICE]=@BUYER_UNITPRICE,
    [UNIT_CODE]=@UNIT_CODE,
    [STOCKINHAND]=@STOCKINHAND,
    [MAKERREF]=@MAKERREF,
    [ORDERED_QTY]=@ORDERED_QTY,
    [QTY]=@QTY,
    [DISCOUNT]=@DISCOUNT,
    [BUYERUNITID]=@BUYERUNITID,
    [SUPPLIERUNITID]=@SUPPLIERUNITID,
    [CONVERSION_FACTOR]=@CONVERSION_FACTOR,
    [STOCKABLE]=@STOCKABLE,
    [TOSPLIT]=@TOSPLIT,
    [UDF1]=@UDF1,
    [UDF2]=@UDF2,
    [UDF3]=@UDF3,
    [QUOTATIONDETAILID]=@QUOTATIONDETAILID,
    [DELIVERY_DAYS]=@DELIVERY_DAYS,
    [ITEM_REMARKS]=@ITEM_REMARKS,
    [PROFITMARGIN]=@PROFITMARGIN,
    [PCK_UNITID]=@PCK_UNITID,
    [PACK_QTY]=@PACK_QTY,
    [UPDATE_DATE]=@UPDATE_DATE,
    [CREATED_DATE]=@CREATED_DATE,
    [UPDATED_BY]=@UPDATED_BY,
    [CREATED_BY]=@CREATED_BY,
    [QTD_STOCK]=@QTD_STOCK,
    [BUYER_STATUS] = @BUYER_STATUS,
[APPROVED_VENDORID] = @APPROVED_VENDORID

WHERE [SALESORDERDETAILID]=@SALESORDERDETAILID
END

GO

CREATE PROC sp_Select_SM_QUOTATIONS_BUYERs_By_SALESORDERID
(
@SALESORDERID INT
)
AS
BEGIN

SELECT * FROM SM_QUOTATIONS_BUYER
WHERE SALESORDERID = @SALESORDERID

END
GO
ALTER TABLE LES_SALESORDER DROP COLUMN VESSEL_ETA,VESSEL_ARRTIME;
GO

CREATE TABLE [dbo].[LES_SALES_MAPPED_CURRENCY](
	[AUTOID] [int] IDENTITY(1,1) NOT NULL,
	[SOURCE_CURR_CODE] [nvarchar](50) NULL,
	[TARGET_CURR_CODE] [nvarchar](max) NULL,
	[CURRENCYID] [int] NULL,
 CONSTRAINT [PK_LES_SALES_MAPPED_CURRENCY] PRIMARY KEY CLUSTERED 
(
	[AUTOID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

create procedure [dbo].[sp_LeS_Sales_Currency_Details]
(
	@CURRDETAIL nvarchar(max)
)
AS
Begin
	SELECT * FROM  LES_SALES_MAPPED_CURRENCY WHERE SOURCE_CURR_CODE LIKE '%'+@CURRDETAIL+'%' OR TARGET_CURR_CODE LIKE '%'+@CURRDETAIL+'%';
End
go

ALTER VIEW [dbo].[SMV_LES_SALESORDER_AMOUNT] AS 
SELECT LES_SALESORDER.SALESORDERID,ITEMSUM.GROSS_ITEM_TOTAL,
(ITEMSUM.NET_ITEM_TOTAL*((100 - ISNULL(dbo.LES_SALESORDER.DISCOUNT,0)) / 100)+ISNULL(FREIGHTAMT,0)+ISNULL(OTHERCOSTS,0)) AS QUOTE_TOTAL FROM 
(SELECT 	 dbo.LES_SALESORDER_DETAILS.SALESORDERID, SUM(ISNULL(dbo.LES_SALESORDER_DETAILS.QTY,0) * ISNULL(dbo.LES_SALESORDER_DETAILS.VENDOR_UNITPRICE,0)) 
                      AS GROSS_ITEM_TOTAL, 
SUM(((ISNULL(dbo.LES_SALESORDER_DETAILS.QTY,0) * ISNULL(dbo.LES_SALESORDER_DETAILS.VENDOR_UNITPRICE,0)) * (100 + ISNULL(dbo.LES_SALESORDER_DETAILS.PROFITMARGIN,0)) / 100)
                      * (100 - ISNULL(dbo.LES_SALESORDER_DETAILS.DISCOUNT,0)) / 100) AS NET_ITEM_TOTAL 
FROM dbo.LES_SALESORDER_DETAILS
GROUP BY dbo.LES_SALESORDER_DETAILS.SALESORDERID) as ITEMSUM
INNER JOIN LES_SALESORDER ON ITEMSUM.SALESORDERID= LES_SALESORDER.SALESORDERID
GO


CREATE PROCEDURE [dbo].[sp_SM_QUOTATION_SALESORDERID]
(
@SALESORDERID INT
)
AS
BEGIN
SELECT  DISTINCT * FROM SM_QUOTATIONS_BUYER WHERE SALESORDERID=@SALESORDERID AND VENDOR_STATUS=4
END
go
CREATE VIEW [dbo].[SMV_EXPORT_SALES_TRANSACTIONS_PO]
AS
SELECT        QUOTATIONID, VRNO, DOCID, QUOTE_ADDRESSID, BUYER_ADDRESSID, CURR_CODE, CREATED_DATE, PORT_CODE, EXPORTED
FROM            dbo.SM_QUOTATIONS_BUYER WHERE EXPORTED=1 AND DOC_TYPE='Order'

GO
CREATE VIEW [dbo].[SMV_EXPORT_SALES_TRANSACTIONS_RFQ]
AS
SELECT        QUOTATIONID, VRNO, DOCID, QUOTE_ADDRESSID, BUYER_ADDRESSID, CURR_CODE, CREATED_DATE, PORT_CODE, EXPORTED
FROM            dbo.SM_QUOTATIONS_BUYER WHERE EXPORTED=1 AND DOC_TYPE='RequestForQuote'
GO


ALTER PROCEDURE [dbo].[select_SALESTRANSACTIONS_BY_SALESORDERID]
(
@SALESORDERID int
)
AS
BEGIN
SELECT SM_QUOTATIONS_BUYER.QUOTATIONID,VRNO,B.ADDR_CODE AS BUYER_CODE,B.ADDR_NAME AS BUYER_NAME,S.ADDR_CODE AS SUPPLIER_CODE,
S.ADDR_NAME AS SUPPLIER_NAME,
DOC_TYPE,
RIGHT('0'+CAST(DATEPART(D,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,SM_QUOTATIONS_BUYER.CREATED_DATE) AS VARCHAR) AS RFQ_RECEIVED_DATE, 
CASE WHEN UPPER(DOC_TYPE) IN ('QUOTE','QUOTATION','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,RFQ_ACK_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,RFQ_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,RFQ_ACK_DATE) AS VARCHAR) END AS RFQ_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+CAST(DATEPART(YYYY,QUOTE_RECVD_DATE) AS VARCHAR) END AS QUOTE_RECVD_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.FREIGHTAMT END AS FREIGHTAMT,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE QUOTE_AMOUNT END AS QUOTE_AMOUNT,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.OTHERCOSTS END AS OTHERCOSTS,CURR_CODE,   
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE   RIGHT('0'+CAST(DATEPART(D,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,SM_QUOTATIONS_BUYER.QUOTE_VALIDITY) AS VARCHAR) END AS QUOTE_VALIDITY, 
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE SM_QUOTATIONS_BUYER.QUOTE_REFERENCE END AS QUOTE_REFERENCE, 		 
RIGHT('0'+CAST(DATEPART(D,PODATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,PODATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,PODATE) AS VARCHAR) AS PODATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,PO_ACK_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,PO_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,PO_ACK_DATE) AS VARCHAR) END AS PO_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,POC_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,POC_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,POC_DATE) AS VARCHAR) END AS POC_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  POC_REFERENCE END AS POC_REFERENCE,
CASE WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=0) THEN 'Draft' 
 WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=1) THEN 'Queued for export' 
 WHEN (ISNULL(SM_QUOTATIONS_BUYER.EXPORTED,0)=2) THEN 'Sent' ELSE '' END AS SENT_STATUS,
PORT_NAME,VESSEL_NAME, VESSEL_IDNO,QUOTE_ADDRESSID,BUYER_ADDRESSID,SM_QUOTATIONS_BUYER.UPDATE_DATE,VENDOR_STATUS
FROM SM_QUOTATIONS_BUYER
INNER JOIN LES_SALESORDER ON SM_QUOTATIONS_BUYER.SALESORDERID = LES_SALESORDER.SALESORDERID
LEFT JOIN SM_ADDRESS S ON SM_QUOTATIONS_BUYER.QUOTE_ADDRESSID=S.ADDRESSID  
LEFT JOIN SM_ADDRESS B ON SM_QUOTATIONS_BUYER.BUYER_ADDRESSID=B.ADDRESSID  
WHERE--  YEAR(SM_QUOTATIONS_VENDOR.UPDATE_DATE)= YEAR(GETDATE()) AND 
SM_QUOTATIONS_BUYER.SALESORDERID=@SALESORDERID
--ORDER BY SM_QUOTATIONS_BUYER.UPDATE_DATE DESC
ORDER BY SM_QUOTATIONS_BUYER.QUOTATIONID DESC
END

GO

CREATE  VIEW [dbo].[LESV_MODULE_ACCESSRIGHTS] AS 
SELECT     LES_MODULE_ACCESS.MODULEACCESSID, LES_MODULE_ACCESS.MODULEACTIONID, LES_MODULE_ACCESS.EXT_USERID, 
                      LES_MODULE_ACCESS.ACCESS_LEVEL, LES_MODULE_ACTIONS.ACTION_NAME, SM_EXTERNAL_USERS.ADDRESSID, SM_EXTERNAL_USERS.EX_USERCODE, 
                      SM_EXTERNAL_USERS.LINKID, SM_EXTERNAL_USERS.EX_USERNAME
FROM         LES_MODULE_ACCESS INNER JOIN
                      LES_MODULE_ACTIONS ON LES_MODULE_ACCESS.MODULEACTIONID = LES_MODULE_ACTIONS.MODULEACTIONID INNER JOIN
                      SM_EXTERNAL_USERS ON LES_MODULE_ACCESS.EXT_USERID = SM_EXTERNAL_USERS.EX_USERID

GO






CREATE procedure [dbo].[sp_Select_LES_SALESORDERs_By_QUOTATIONID](@QUOTATIONID INT)
AS BEGIN 
SELECT  LES_SALESORDER.SALESORDERID,LES_SALESORDER.SALESORDERNO,LES_SALESORDER.CUSTOMERID,LES_SALESORDER.STATUS,LES_SALESORDER.CURRENCYID,LES_SALESORDER.BUYERREF,LES_SALESORDER.SHIPNAME,
LES_SALESORDER.RFQ_DEL_DATE,LES_SALESORDER.DELIVERY_DAYS,LES_SALESORDER.DISCOUNT,LES_SALESORDER.SUPPLIER_REMARKS,LES_SALESORDER.PAY_TERMS,LES_SALESORDER.GENERAL_TERMS,LES_SALESORDER.PROFITMARGIN,LES_SALESORDER.AMOUNT,LES_SALESORDER.ITEM_TOTAL,LES_SALESORDER.FREIGHTAMT,LES_SALESORDER.OTHERCOSTS,LES_SALESORDER.QUOTE_REFERENCE,
LES_SALESORDER.QUOTE_VALIDITY ,LES_SALESORDER.QUOTE_SUBJECT,LES_SALESORDER.QUOTATIONID,LES_SALESORDER.UPDATE_DATE,LES_SALESORDER.CREATED_DATE,LES_SALESORDER.UPDATED_BY,LES_SALESORDER.CREATED_BY,
SM_QUOTATIONS_VENDOR.VESSEL_ETA,LES_SALESORDER.SALES_DOC_TYPE,
BUYER_REMARKS,QUOTE_REMARKS,SM_CURRENCY.CURR_CODE,DOC_TYPE,REPLY_BY_DATE, LATEDATE ,VENDOR_STATUS,
SM_QUOTATIONS_VENDOR.CREATED_DATE AS RFQ_CREATED_DATE,VESSEL_IDNO,VESSEL_NAME,VESSEL_OWNER,VESSEL_OWNER_CODE,PORT_CODE,PORT_NAME FROM [dbo].[LES_SALESORDER]
LEFT JOIN SM_QUOTATIONS_VENDOR ON LES_SALESORDER.QUOTATIONID=SM_QUOTATIONS_VENDOR.QUOTATIONID
LEFT JOIN SM_CURRENCY ON SM_CURRENCY.CURRENCYID=LES_SALESORDER.CURRENCYID WHERE LES_SALESORDER.QUOTATIONID = @QUOTATIONID
END

go


alter table sm_address add PROFITMARGIN FLOAT
GO

CREATE PROCEDURE [dbo].[sp_SM_PARTUNIT_Select_By_Code]
(
@UNIT_CODE NVARCHAR(15)
)
AS 
BEGIN
SELECT * FROM SM_PARTUNIT WHERE UNIT_CODE = @UNIT_CODE
END
GO




ALTER Procedure [dbo].[sp_LES_SALESORDER_Insert]
(
@SALESORDERID int OUTPUT,
@SALESORDERNO nvarchar(50),
@CUSTOMERID int,
@STATUS int,
@SALES_DOC_TYPE NVARCHAR(50),
@CURRENCYID int,
@BUYERREF nvarchar(30),
@SHIPNAME nvarchar(50),
@RFQ_DEL_DATE datetime,
@DELIVERY_DAYS int,
@DISCOUNT float,
@SUPPLIER_REMARKS ntext,
@PAY_TERMS ntext,
@GENERAL_TERMS ntext,
@PROFITMARGIN float,
@AMOUNT float,
@FREIGHTAMT float,
@OTHERCOSTS float,
@QUOTE_REFERENCE nvarchar(30),
@QUOTE_VALIDITY datetime,
@QUOTE_SUBJECT nvarchar(100),
@QUOTATIONID int,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@ITEM_TOTAL float
)
AS
BEGIN

INSERT INTO [dbo].[LES_SALESORDER]
(
[SALESORDERNO],
[CUSTOMERID],
[STATUS],
[SALES_DOC_TYPE],
[CURRENCYID],
[BUYERREF],
[SHIPNAME],
[RFQ_DEL_DATE],
[DELIVERY_DAYS],
[DISCOUNT],
[SUPPLIER_REMARKS],
[PAY_TERMS],
[GENERAL_TERMS],
[PROFITMARGIN],
[AMOUNT],
[FREIGHTAMT],
[OTHERCOSTS],
[QUOTE_REFERENCE],
[QUOTE_VALIDITY],
[QUOTE_SUBJECT],
[QUOTATIONID],
[UPDATE_DATE],
[CREATED_DATE],
[UPDATED_BY],
[CREATED_BY],
[ITEM_TOTAL]
)
VALUES
(
@SALESORDERNO,
@CUSTOMERID,
@STATUS,
@SALES_DOC_TYPE,
@CURRENCYID,
@BUYERREF,
@SHIPNAME,
@RFQ_DEL_DATE,
@DELIVERY_DAYS,
@DISCOUNT,
@SUPPLIER_REMARKS,
@PAY_TERMS,
@GENERAL_TERMS,
@PROFITMARGIN,
@AMOUNT,
@FREIGHTAMT,
@OTHERCOSTS,
@QUOTE_REFERENCE,
@QUOTE_VALIDITY,
@QUOTE_SUBJECT,
@QUOTATIONID,
@UPDATE_DATE,
@CREATED_DATE,
@UPDATED_BY,
@CREATED_BY,
@ITEM_TOTAL
)

Select @SALESORDERID = scope_identity();

END

GO




ALTER Procedure [dbo].[sp_LES_SALESORDER_DETAILS_Insert]
(
@SALESORDERID int,
@INVENTORYID int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@VENDOR_UNITPRICE FLOAT,
@BUYER_UNITPRICE FLOAT,
@STOCKINHAND FLOAT,
@MAKERREF nvarchar(50),
@ORDERED_QTY FLOAT,
@QTY FLOAT,
@DISCOUNT FLOAT,
@BUYERUNITID int,
@UNIT_CODE NVARCHAR(15),
@SUPPLIERUNITID int,
@CONVERSION_FACTOR int,
@STOCKABLE int,
@TOSPLIT int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@QUOTATIONDETAILID int,
@DELIVERY_DAYS int,
@ITEM_REMARKS ntext,
@PROFITMARGIN FLOAT,
@PCK_UNITID int,
@PACK_QTY FLOAT,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@QTD_STOCK FLOAT,
@BUYER_STATUS FLOAT,
@ITEMNO FLOAT,
@APPROVED_VENDORID int
)
AS
BEGIN
    INSERT INTO [dbo].[LES_SALESORDER_DETAILS]
    (
        [SALESORDERID],
[INVENTORYID],
[PARTNAME],
[DRAWINGNO],
[POSNO],
[REFNO],
[VENDOR_UNITPRICE],
[BUYER_UNITPRICE],
[STOCKINHAND],
[MAKERREF],
[ORDERED_QTY],
[QTY],
[DISCOUNT],
[BUYERUNITID],
[UNIT_CODE],
[SUPPLIERUNITID],
[CONVERSION_FACTOR],
[STOCKABLE],
[TOSPLIT],
[UDF1],
[UDF2],
[UDF3],
[QUOTATIONDETAILID],
[DELIVERY_DAYS],
[ITEM_REMARKS],
[PROFITMARGIN],
[PCK_UNITID],
[PACK_QTY],
[UPDATE_DATE],
[CREATED_DATE],
[UPDATED_BY],
[CREATED_BY],
[QTD_STOCK],
[BUYER_STATUS],
[ITEMNO],
[APPROVED_VENDORID]
    )
    VALUES
    (
        @SALESORDERID,
@INVENTORYID,
@PARTNAME,
@DRAWINGNO,
@POSNO,
@REFNO,
@VENDOR_UNITPRICE,
@BUYER_UNITPRICE,
@STOCKINHAND,
@MAKERREF,
@ORDERED_QTY,
@QTY,
@DISCOUNT,
@BUYERUNITID,
@UNIT_CODE,
@SUPPLIERUNITID,
@CONVERSION_FACTOR,
@STOCKABLE,
@TOSPLIT,
@UDF1,
@UDF2,
@UDF3,
@QUOTATIONDETAILID,
@DELIVERY_DAYS,
@ITEM_REMARKS,
@PROFITMARGIN,
@PCK_UNITID,
@PACK_QTY,
@UPDATE_DATE,
@CREATED_DATE,
@UPDATED_BY,
@CREATED_BY,
@QTD_STOCK,
@BUYER_STATUS,
@ITEMNO,
@APPROVED_VENDORID
    )
    Select @@identity;
END


GO

ALTER Procedure [dbo].[sp_LES_SALESORDER]
(
@SALESORDERID int
)
AS
BEGIN
SELECT  [LES_SALESORDER].*,BUYER_REMARKS,QUOTE_REMARKS,
SM_CURRENCY.CURR_CODE,DOC_TYPE,REPLY_BY_DATE,LATEDATE,VENDOR_STATUS,
SM_QUOTATIONS_VENDOR.CREATED_DATE AS RFQ_CREATED_DATE,SM_QUOTATIONS_VENDOR.VESSEL_ETA,
VESSEL_IDNO,VESSEL_NAME,VESSEL_OWNER,
VESSEL_OWNER_CODE,PORT_CODE,PORT_NAME,
[VERSION],SM_QUOTATIONS_VENDOR.QUOTE_REFERENCE AS 'VENDOR_QUOTE_REF'
FROM [dbo].[LES_SALESORDER]
LEFT JOIN SM_QUOTATIONS_VENDOR ON LES_SALESORDER.QUOTATIONID=SM_QUOTATIONS_VENDOR.QUOTATIONID
LEFT JOIN SM_CURRENCY ON SM_CURRENCY.CURRENCYID=LES_SALESORDER.CURRENCYID
WHERE [SALESORDERID]=@SALESORDERID

END

GO


CREATE Procedure [dbo].[sp_LES_SALESORDER_Update_AllFields]
(
@SALESORDERID int,
@SALESORDERNO nvarchar(50),
@CUSTOMERID int,
@STATUS int,
@SALES_DOC_TYPE NVARCHAR(50),
@CURRENCYID int,
@BUYERREF nvarchar(30),
@SHIPNAME nvarchar(50),
@RFQ_DEL_DATE datetime,
@DELIVERY_DAYS int,
@DISCOUNT float,
@SUPPLIER_REMARKS  ntext,
@PAY_TERMS  ntext,
@GENERAL_TERMS  ntext,
@PROFITMARGIN float,
@AMOUNT float,
@FREIGHTAMT float,
@OTHERCOSTS float,
@QUOTE_REFERENCE nvarchar(30),
@QUOTE_VALIDITY datetime,
@QUOTE_SUBJECT nvarchar(100),
@QUOTATIONID int,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@ITEM_TOTAL float
)
AS
BEGIN
    UPDATE [dbo].[LES_SALESORDER]
    SET
        [SALESORDERNO]=@SALESORDERNO,
        [CUSTOMERID]=@CUSTOMERID,
        [STATUS]=@STATUS,
		[SALES_DOC_TYPE]=@SALES_DOC_TYPE,
        [CURRENCYID]=@CURRENCYID,
        [BUYERREF]=@BUYERREF,
        [SHIPNAME]=@SHIPNAME,
        [RFQ_DEL_DATE]=@RFQ_DEL_DATE,
        [DELIVERY_DAYS]=@DELIVERY_DAYS,
        [DISCOUNT]=@DISCOUNT,
        [SUPPLIER_REMARKS]=@SUPPLIER_REMARKS,
        [PAY_TERMS]=@PAY_TERMS,
        [GENERAL_TERMS]=@GENERAL_TERMS,
        [PROFITMARGIN]=@PROFITMARGIN,
        [AMOUNT]=@AMOUNT,
        [FREIGHTAMT]=@FREIGHTAMT,
        [OTHERCOSTS]=@OTHERCOSTS,
        [QUOTE_REFERENCE]=@QUOTE_REFERENCE,
        [QUOTE_VALIDITY]=@QUOTE_VALIDITY,
        [QUOTE_SUBJECT]=@QUOTE_SUBJECT,
        [QUOTATIONID]=@QUOTATIONID,
        [UPDATE_DATE]=@UPDATE_DATE,
        [CREATED_DATE]=@CREATED_DATE,
        [UPDATED_BY]=@UPDATED_BY,
        [CREATED_BY]=@CREATED_BY,
        [ITEM_TOTAL]=@ITEM_TOTAL
WHERE   [SALESORDERID]=@SALESORDERID
END


GO



Create Procedure [dbo].[sp_LES_SALESORDER_DETAILS_Select_One]
(
@SALESORDERDETAILID int
)
AS
BEGIN
    SELECT *
    FROM [dbo].[LES_SALESORDER_DETAILS]
    WHERE
        [SALESORDERDETAILID]=@SALESORDERDETAILID
END




GO

CREATE Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_Insert]
(
@QUOTATIONID INT OUTPUT,
@DOC_XML nvarchar(5),
@DOCID nvarchar(256),
@DOC_TYPE nvarchar(50),
@VRNO nvarchar(50),
@BUYER_VRNO nvarchar(50),
@SUPPLIER_VRNO nvarchar(50),
@QUOTE_ADDRESSID int,
@BUYER_ADDRESSID int,
@RFQ_SENT_DATE datetime,
@QUOTE_RECVD_DATE datetime,
@CURRENCYID int,
@CURR_CODE nvarchar(3),
@QUOTE_AMOUNT float,
@QUOTE_EXCHRATE float,
@ITEM_TOTAL float,
@OTHERCOSTS float,
@FREIGHTAMT float,
@PAYMENT_TERMS int,
@QUOTE_DISCOUNT float,
@ADDITIONAL_DISC float,
@ADD_DISC_TYPE tinyint,
@QUOTE_VALIDITY datetime,
@QUOTE_REMARKS nvarchar(max),
@UPDATE_DATE datetime,
@DELIVERYTIME datetime,
@PAYLOADID nvarchar(100),
@CREATED_DATE datetime,
@SITEID int,
@SENT_BY int,
@PORT_CODE nvarchar(15),
@PORT_NAME nvarchar(100),
@QUOTE_APPROVEDDATE datetime,
@DELIVERYDAYS int,
@QUOTE_SUBMIT_BY int,
@QUOTE_STATUS int,
@QUOTE_REFERENCE nvarchar(30),
@REPLY_BY_DATE datetime,
@QUOTE_SUBMIT_DATE datetime,
@VENDOR_STATUS int,
@CHANGED_BY_VENDOR tinyint,
@LATEDATE datetime,
@RFQ_ACK_DATE datetime,
@PO_ACK_DATE datetime,
@POC_REFERENCE nvarchar(30),
@PODATE datetime,
@POC_DATE datetime,
@POC_BY int,
@BUYER_REMARKS nvarchar(3000),
@VESSEL_NAME nvarchar(100),
@VESSEL_IDNO nvarchar(50),
@VESSEL_OWNER nvarchar(150),
@VESSEL_OWNER_CODE nvarchar(50),
@EXPORTED smallint,
@VERSION tinyint,
@RFQ_EXPORT tinyint,
@QUOTE_FILE_REF nvarchar(150),
@PRINT_STATUS int,
@QUOTE_FILE_STAMP nvarchar(50),
@DELIVERY_PROMISED datetime,
@GENERAL_TERMS nvarchar(100),
@PAY_TERMS nvarchar(100),
@TAX_PERCNT float,
@QUOTE_VERSION int,
@IS_DECLINED int,
@QUOTE_SUBJECT nvarchar(100),
@SP_MAS_REMARK nvarchar(500),
@BYR_SUPP_LINKID int,
@ATTACHMENT1 nvarchar(150),
@ATTACHMENT2 nvarchar(150),
@ALLOWANCE float,
@SALESORDERID int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@RevisionNumber nvarchar(50),
@LINK_RECORDID int,
@TRANSPORT_MODE nvarchar(20),
@OrderHandling nvarchar(50),
@OrderType nvarchar(50),
@OriginatingRequestNo nvarchar(50),
@ShipComplete nvarchar(20),
@SupplierORGRef nvarchar(50),
@UpdType nvarchar(50),
@ContractType nvarchar(50),
@OrgSystemRef nvarchar(100),
@OTHER_COST2 float,
@OTHER_COST3 float,
@VESSEL_ARRTIME NVARCHAR (15),
@VESSEL_ETA DATETIME
)
AS
BEGIN
    INSERT INTO [dbo].[SM_QUOTATIONS_BUYER]
    (
        [DOC_XML],
[DOCID],
[DOC_TYPE],
[VRNO],
[BUYER_VRNO],
[SUPPLIER_VRNO],
[QUOTE_ADDRESSID],
[BUYER_ADDRESSID],
[RFQ_SENT_DATE],
[QUOTE_RECVD_DATE],
[CURRENCYID],
[CURR_CODE],
[QUOTE_AMOUNT],
[QUOTE_EXCHRATE],
[ITEM_TOTAL],
[OTHERCOSTS],
[FREIGHTAMT],
[PAYMENT_TERMS],
[QUOTE_DISCOUNT],
[ADDITIONAL_DISC],
[ADD_DISC_TYPE],
[QUOTE_VALIDITY],
[QUOTE_REMARKS],
[UPDATE_DATE],
[DELIVERYTIME],
[PAYLOADID],
[CREATED_DATE],
[SITEID],
[SENT_BY],
[PORT_CODE],
[PORT_NAME],
[QUOTE_APPROVEDDATE],
[DELIVERYDAYS],
[QUOTE_SUBMIT_BY],
[QUOTE_STATUS],
[QUOTE_REFERENCE],
[REPLY_BY_DATE],
[QUOTE_SUBMIT_DATE],
[VENDOR_STATUS],
[CHANGED_BY_VENDOR],
[LATEDATE],
[RFQ_ACK_DATE],
[PO_ACK_DATE],
[POC_REFERENCE],
[PODATE],
[POC_DATE],
[POC_BY],
[BUYER_REMARKS],
[VESSEL_NAME],
[VESSEL_IDNO],
[VESSEL_OWNER],
[VESSEL_OWNER_CODE],
[EXPORTED],
[VERSION],
[RFQ_EXPORT],
[QUOTE_FILE_REF],
[PRINT_STATUS],
[QUOTE_FILE_STAMP],
[DELIVERY_PROMISED],
[GENERAL_TERMS],
[PAY_TERMS],
[TAX_PERCNT],
[QUOTE_VERSION],
[IS_DECLINED],
[QUOTE_SUBJECT],
[SP_MAS_REMARK],
[BYR_SUPP_LINKID],
[ATTACHMENT1],
[ATTACHMENT2],
[ALLOWANCE],
[SALESORDERID],
[UDF1],
[UDF2],
[UDF3],
[RevisionNumber],
[LINK_RECORDID],
[TRANSPORT_MODE],
[OrderHandling],
[OrderType],
[OriginatingRequestNo],
[ShipComplete],
[SupplierORGRef],
[UpdType],
[ContractType],
[OrgSystemRef],
[OTHER_COST2],
[OTHER_COST3],
[VESSEL_ARRTIME],
[VESSEL_ETA]
    )
    VALUES
    (
        @DOC_XML,
@DOCID,
@DOC_TYPE,
@VRNO,
@BUYER_VRNO,
@SUPPLIER_VRNO,
@QUOTE_ADDRESSID,
@BUYER_ADDRESSID,
@RFQ_SENT_DATE,
@QUOTE_RECVD_DATE,
@CURRENCYID,
@CURR_CODE,
@QUOTE_AMOUNT,
@QUOTE_EXCHRATE,
@ITEM_TOTAL,
@OTHERCOSTS,
@FREIGHTAMT,
@PAYMENT_TERMS,
@QUOTE_DISCOUNT,
@ADDITIONAL_DISC,
@ADD_DISC_TYPE,
@QUOTE_VALIDITY,
@QUOTE_REMARKS,
@UPDATE_DATE,
@DELIVERYTIME,
@PAYLOADID,
@CREATED_DATE,
@SITEID,
@SENT_BY,
@PORT_CODE,
@PORT_NAME,
@QUOTE_APPROVEDDATE,
@DELIVERYDAYS,
@QUOTE_SUBMIT_BY,
@QUOTE_STATUS,
@QUOTE_REFERENCE,
@REPLY_BY_DATE,
@QUOTE_SUBMIT_DATE,
@VENDOR_STATUS,
@CHANGED_BY_VENDOR,
@LATEDATE,
@RFQ_ACK_DATE,
@PO_ACK_DATE,
@POC_REFERENCE,
@PODATE,
@POC_DATE,
@POC_BY,
@BUYER_REMARKS,
@VESSEL_NAME,
@VESSEL_IDNO,
@VESSEL_OWNER,
@VESSEL_OWNER_CODE,
@EXPORTED,
@VERSION,
@RFQ_EXPORT,
@QUOTE_FILE_REF,
@PRINT_STATUS,
@QUOTE_FILE_STAMP,
@DELIVERY_PROMISED,
@GENERAL_TERMS,
@PAY_TERMS,
@TAX_PERCNT,
@QUOTE_VERSION,
@IS_DECLINED,
@QUOTE_SUBJECT,
@SP_MAS_REMARK,
@BYR_SUPP_LINKID,
@ATTACHMENT1,
@ATTACHMENT2,
@ALLOWANCE,
@SALESORDERID,
@UDF1,
@UDF2,
@UDF3,
@RevisionNumber,
@LINK_RECORDID,
@TRANSPORT_MODE,
@OrderHandling,
@OrderType,
@OriginatingRequestNo,
@ShipComplete,
@SupplierORGRef,
@UpdType,
@ContractType,
@OrgSystemRef,
@OTHER_COST2,
@OTHER_COST3,
@VESSEL_ARRTIME,
@VESSEL_ETA

    )
   Select @QUOTATIONID = scope_identity();
END




GO



Create Procedure [dbo].[sp_SM_QUOTATIONDETAIL_BUYER_Insert]
(
@QUOTATIONDETAILID INT OUTPUT,
@QUOTATIONID int,
@ITEMSTATUS int,
@ITEMNO int,
@VENDOR_ITEMNO nvarchar(20),
@QTY_REQ float,
@QTY_QUOTED float,
@QTY_ORD float,
@QUOTED_PRICE float,
@QUOTE_EXCHRATE float,
@DISCOUNT float,
@DELIVERYTIME int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@UNIT_CODE nvarchar(15),
@EQUIP_NAME nvarchar(200),
@EQUIP_MAKER nvarchar(512),
@EQUIP_TYPE nvarchar(200),
@EQUIP_SERNO nvarchar(200),
@EQUIP_REMARKS nvarchar(1000),
@QUOTEITEM_REMARK ntext,
@ITEM_REMARK nvarchar(2048),
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@CHANGED_BY_VENDOR int,
@SITEID int,
@DOCITEMID nvarchar(256),
@QUOTE_FILE nvarchar(50),
@VENDOR_REFNO nvarchar(50),
@ORIGINATINGSYSTEMREF nvarchar(50),
@ITEM_MARKED_REMARK nvarchar(max),
@SYS_ITEMNO int,
@BUYER_UNIT_CODE nvarchar(15),
@ITEM_TYPE nvarchar(20),
@LINK_RECORD_ID int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@SupplierORGRef nvarchar(20),
@SALESORDERID int,
@SALESORDERITEMID int,
@VENDOR_ITEMNAME nvarchar(500),
@BuyerORGRef nvarchar(40)
)
AS
BEGIN
    INSERT INTO [dbo].[SM_QUOTATIONDETAIL_BUYER]
    (
        [QUOTATIONID],
[ITEMSTATUS],
[ITEMNO],
[VENDOR_ITEMNO],
[QTY_REQ],
[QTY_QUOTED],
[QTY_ORD],
[QUOTED_PRICE],
[QUOTE_EXCHRATE],
[DISCOUNT],
[DELIVERYTIME],
[PARTNAME],
[DRAWINGNO],
[POSNO],
[REFNO],
[UNIT_CODE],
[EQUIP_NAME],
[EQUIP_MAKER],
[EQUIP_TYPE],
[EQUIP_SERNO],
[EQUIP_REMARKS],
[QUOTEITEM_REMARK],
[ITEM_REMARK],
[UPDATE_DATE],
[CREATED_DATE],
[CHANGED_BY_VENDOR],
[SITEID],
[DOCITEMID],
[QUOTE_FILE],
[VENDOR_REFNO],
[ORIGINATINGSYSTEMREF],
[ITEM_MARKED_REMARK],
[SYS_ITEMNO],
[BUYER_UNIT_CODE],
[ITEM_TYPE],
[LINK_RECORD_ID],
[UDF1],
[UDF2],
[UDF3],
[SupplierORGRef],
[SALESORDERID],
[SALESORDERITEMID],
[VENDOR_ITEMNAME],
[BuyerORGRef]
    )
    VALUES
    (
        @QUOTATIONID,
@ITEMSTATUS,
@ITEMNO,
@VENDOR_ITEMNO,
@QTY_REQ,
@QTY_QUOTED,
@QTY_ORD,
@QUOTED_PRICE,
@QUOTE_EXCHRATE,
@DISCOUNT,
@DELIVERYTIME,
@PARTNAME,
@DRAWINGNO,
@POSNO,
@REFNO,
@UNIT_CODE,
@EQUIP_NAME,
@EQUIP_MAKER,
@EQUIP_TYPE,
@EQUIP_SERNO,
@EQUIP_REMARKS,
@QUOTEITEM_REMARK,
@ITEM_REMARK,
@UPDATE_DATE,
@CREATED_DATE,
@CHANGED_BY_VENDOR,
@SITEID,
@DOCITEMID,
@QUOTE_FILE,
@VENDOR_REFNO,
@ORIGINATINGSYSTEMREF,
@ITEM_MARKED_REMARK,
@SYS_ITEMNO,
@BUYER_UNIT_CODE,
@ITEM_TYPE,
@LINK_RECORD_ID,
@UDF1,
@UDF2,
@UDF3,
@SupplierORGRef,
@SALESORDERID,
@SALESORDERITEMID,
@VENDOR_ITEMNAME,
@BuyerORGRef

    )
    Select @QUOTATIONDETAILID = scope_identity();
END




GO



CREATE Procedure [dbo].[sp_LES_SALESORDER_DETAILS_Update_1]
(
@SALESORDERDETAILID int,
@SALESORDERID int,
@ITEMNO nvarchar(20),
@INVENTORYID int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@VENDOR_UNITPRICE float,
@BUYER_UNITPRICE float,
@STOCKINHAND float,
@MAKERREF nvarchar(50),
@ORDERED_QTY float,
@QTY float,
@DISCOUNT float,
@BUYERUNITID int,
@SUPPLIERUNITID int,
@CONVERSION_FACTOR int,
@STOCKABLE int,
@TOSPLIT int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@QUOTATIONDETAILID int,
@DELIVERY_DAYS int,
@ITEM_REMARKS ntext,
@PROFITMARGIN float,
@PCK_UNITID int,
@PACK_QTY float,
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@UPDATED_BY int,
@CREATED_BY int,
@QTD_STOCK float,
@BUYER_STATUS INT,
@UNIT_CODE nvarchar(50),
@APPROVED_VENDORID INT
)
AS
BEGIN
    UPDATE [dbo].[LES_SALESORDER_DETAILS]
    SET
    [SALESORDERID]=@SALESORDERID,
    [ITEMNO]=@ITEMNO,
    [INVENTORYID]=@INVENTORYID,
    [PARTNAME]=@PARTNAME,
    [DRAWINGNO]=@DRAWINGNO,
    [POSNO]=@POSNO,
    [REFNO]=@REFNO,
    [VENDOR_UNITPRICE]=@VENDOR_UNITPRICE,
    [BUYER_UNITPRICE]=@BUYER_UNITPRICE,
    [UNIT_CODE]=@UNIT_CODE,
    [STOCKINHAND]=@STOCKINHAND,
    [MAKERREF]=@MAKERREF,
    [ORDERED_QTY]=@ORDERED_QTY,
    [QTY]=@QTY,
    [DISCOUNT]=@DISCOUNT,
    [BUYERUNITID]=@BUYERUNITID,
    [SUPPLIERUNITID]=@SUPPLIERUNITID,
    [CONVERSION_FACTOR]=@CONVERSION_FACTOR,
    [STOCKABLE]=@STOCKABLE,
    [TOSPLIT]=@TOSPLIT,
    [UDF1]=@UDF1,
    [UDF2]=@UDF2,
    [UDF3]=@UDF3,
    [QUOTATIONDETAILID]=@QUOTATIONDETAILID,
    [DELIVERY_DAYS]=@DELIVERY_DAYS,
    [ITEM_REMARKS]=@ITEM_REMARKS,
    [PROFITMARGIN]=@PROFITMARGIN,
    [PCK_UNITID]=@PCK_UNITID,
    [PACK_QTY]=@PACK_QTY,
    [UPDATE_DATE]=@UPDATE_DATE,
    [CREATED_DATE]=@CREATED_DATE,
    [UPDATED_BY]=@UPDATED_BY,
    [CREATED_BY]=@CREATED_BY,
    [QTD_STOCK]=@QTD_STOCK,
    [BUYER_STATUS] = @BUYER_STATUS,
[APPROVED_VENDORID] = @APPROVED_VENDORID

WHERE [SALESORDERDETAILID]=@SALESORDERDETAILID
END


GO



Create Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_Select_One]
(
@QUOTATIONID int
)
AS
BEGIN
    SELECT *
    FROM [dbo].[SM_QUOTATIONS_BUYER]
    WHERE
        [QUOTATIONID]=@QUOTATIONID
END

GO



CREATE PROCEDURE [dbo].[sp_SM_QUOTATION_BUYER_ITEMS_QuotationID]
(
@QUOTATIONID INT
)
AS
BEGIN

SELECT QUOTATIONDETAILID,QUOTATIONID,
	ITEMNO,VENDOR_ITEMNO,
	ISNULL(REFNO,'') AS 'REFNO',
	VENDOR_REFNO,
	PARTNAME,
	BUYER_UNIT_CODE,PARTUNITID,
	ISNULL(SM_QUOTATIONDETAIL_BUYER.UNIT_CODE,BUYER_UNIT_CODE) AS UNIT_CODE,
	QTY_REQ,
	QTY_QUOTED,
	QTY_ORD,
	QUOTED_PRICE,
	DISCOUNT,
	DELIVERYTIME,	
	(ISNULL(PARTNAME,'') + (case when (REFNO is not null or REFNO<>'') then ('|Ref. No. :'+REFNO) else '' end)+
	(case when (DRAWINGNO is not null or DRAWINGNO <> '') then ('|Drawing No.:'+ DRAWINGNO) else '' end))
	+('|Equipment : '+ 	ISNULL(EQUIP_NAME,'')+'/'+	ISNULL(EQUIP_MAKER,'')+'/'+
	ISNULL(EQUIP_TYPE,'')+'/'+	ISNULL(EQUIP_SERNO,'')+'/'+	ISNULL(EQUIP_REMARKS,'')
	+'|Remarks : '+ISNULL(ITEM_REMARK,''))
	AS DISPLAY_PARTNAME, 
	ITEM_REMARK,QUOTEITEM_REMARK
    FROM SM_QUOTATIONDETAIL_BUYER left join sm_partunit on  SM_QUOTATIONDETAIL_BUYER.UNIT_CODE=sm_partunit.unit_code 
 WHERE [QUOTATIONID]=@QUOTATIONID
    ORDER BY ITEMNO
END


GO



Create Procedure [dbo].[sp_SM_QUOTATIONDETAIL_BUYER_Select_BY_QUOTATIONID]
(
@QUOTATIONID int
)
AS
BEGIN
    SELECT *
    FROM [dbo].[SM_QUOTATIONDETAIL_BUYER]
    WHERE
        [QUOTATIONID]=@QUOTATIONID
END




GO



CREATE Procedure [dbo].[sp_SM_QUOTATIONS_BUYER_Update]
(
@QUOTATIONID int,
@DOC_XML nvarchar(5),
@DOCID nvarchar(256),
@DOC_TYPE nvarchar(50),
@VRNO nvarchar(50),
@BUYER_VRNO nvarchar(50),
@SUPPLIER_VRNO nvarchar(50),
@QUOTE_ADDRESSID int,
@BUYER_ADDRESSID int,
@RFQ_SENT_DATE datetime,
@QUOTE_RECVD_DATE datetime,
@CURRENCYID int,
@CURR_CODE nvarchar(3),
@QUOTE_AMOUNT float,
@QUOTE_EXCHRATE float,
@ITEM_TOTAL float,
@OTHERCOSTS float,
@FREIGHTAMT float,
@PAYMENT_TERMS int,
@QUOTE_DISCOUNT float,
@ADDITIONAL_DISC float,
@ADD_DISC_TYPE tinyint,
@QUOTE_VALIDITY datetime,
@QUOTE_REMARKS nvarchar(max),
@UPDATE_DATE datetime,
@DELIVERYTIME datetime,
@PAYLOADID nvarchar(100),
@CREATED_DATE datetime,
@SITEID int,
@SENT_BY int,
@PORT_CODE nvarchar(15),
@PORT_NAME nvarchar(100),
@QUOTE_APPROVEDDATE datetime,
@DELIVERYDAYS int,
@QUOTE_SUBMIT_BY int,
@QUOTE_STATUS int,
@QUOTE_REFERENCE nvarchar(30),
@REPLY_BY_DATE datetime,
@QUOTE_SUBMIT_DATE datetime,
@VENDOR_STATUS int,
@CHANGED_BY_VENDOR tinyint,
@LATEDATE datetime,
@RFQ_ACK_DATE datetime,
@PO_ACK_DATE datetime,
@POC_REFERENCE nvarchar(30),
@PODATE datetime,
@POC_DATE datetime,
@POC_BY int,
@BUYER_REMARKS nvarchar(3000),
@VESSEL_NAME nvarchar(100),
@VESSEL_IDNO nvarchar(50),
@VESSEL_OWNER nvarchar(150),
@VESSEL_OWNER_CODE nvarchar(50),
@EXPORTED smallint,
@VERSION tinyint,
@RFQ_EXPORT tinyint,
@QUOTE_FILE_REF nvarchar(150),
@PRINT_STATUS int,
@QUOTE_FILE_STAMP nvarchar(50),
@DELIVERY_PROMISED datetime,
@GENERAL_TERMS nvarchar(100),
@PAY_TERMS nvarchar(100),
@TAX_PERCNT float,
@QUOTE_VERSION int,
@IS_DECLINED int,
@QUOTE_SUBJECT nvarchar(100),
@SP_MAS_REMARK nvarchar(500),
@BYR_SUPP_LINKID int,
@ATTACHMENT1 nvarchar(150),
@ATTACHMENT2 nvarchar(150),
@ALLOWANCE float,
@SALESORDERID int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@RevisionNumber nvarchar(50),
@LINK_RECORDID int,
@TRANSPORT_MODE nvarchar(20),
@OrderHandling nvarchar(50),
@OrderType nvarchar(50),
@OriginatingRequestNo nvarchar(50),
@ShipComplete nvarchar(20),
@SupplierORGRef nvarchar(50),
@UpdType nvarchar(50),
@ContractType nvarchar(50),
@OrgSystemRef nvarchar(100),
@OTHER_COST2 float,
@OTHER_COST3 float,
@VESSEL_ARRTIME NVARCHAR (15),
@VESSEL_ETA DATETIME
)
AS
BEGIN
    UPDATE [dbo].[SM_QUOTATIONS_BUYER]
    SET
        [DOC_XML]=@DOC_XML,
        [DOCID]=@DOCID,
        [DOC_TYPE]=@DOC_TYPE,
        [VRNO]=@VRNO,
        [BUYER_VRNO]=@BUYER_VRNO,
        [SUPPLIER_VRNO]=@SUPPLIER_VRNO,
        [QUOTE_ADDRESSID]=@QUOTE_ADDRESSID,
        [BUYER_ADDRESSID]=@BUYER_ADDRESSID,
        [RFQ_SENT_DATE]=@RFQ_SENT_DATE,
        [QUOTE_RECVD_DATE]=@QUOTE_RECVD_DATE,
        [CURRENCYID]=@CURRENCYID,
        [CURR_CODE]=@CURR_CODE,
        [QUOTE_AMOUNT]=@QUOTE_AMOUNT,
        [QUOTE_EXCHRATE]=@QUOTE_EXCHRATE,
        [ITEM_TOTAL]=@ITEM_TOTAL,
        [OTHERCOSTS]=@OTHERCOSTS,
        [FREIGHTAMT]=@FREIGHTAMT,
        [PAYMENT_TERMS]=@PAYMENT_TERMS,
        [QUOTE_DISCOUNT]=@QUOTE_DISCOUNT,
        [ADDITIONAL_DISC]=@ADDITIONAL_DISC,
        [ADD_DISC_TYPE]=@ADD_DISC_TYPE,
        [QUOTE_VALIDITY]=@QUOTE_VALIDITY,
        [QUOTE_REMARKS]=@QUOTE_REMARKS,
        [UPDATE_DATE]=@UPDATE_DATE,
        [DELIVERYTIME]=@DELIVERYTIME,
        [PAYLOADID]=@PAYLOADID,
        [CREATED_DATE]=@CREATED_DATE,
        [SITEID]=@SITEID,
        [SENT_BY]=@SENT_BY,
        [PORT_CODE]=@PORT_CODE,
        [PORT_NAME]=@PORT_NAME,
        [QUOTE_APPROVEDDATE]=@QUOTE_APPROVEDDATE,
        [DELIVERYDAYS]=@DELIVERYDAYS,
        [QUOTE_SUBMIT_BY]=@QUOTE_SUBMIT_BY,
        [QUOTE_STATUS]=@QUOTE_STATUS,
        [QUOTE_REFERENCE]=@QUOTE_REFERENCE,
        [REPLY_BY_DATE]=@REPLY_BY_DATE,
        [QUOTE_SUBMIT_DATE]=@QUOTE_SUBMIT_DATE,
        [VENDOR_STATUS]=@VENDOR_STATUS,
        [CHANGED_BY_VENDOR]=@CHANGED_BY_VENDOR,
        [LATEDATE]=@LATEDATE,
        [RFQ_ACK_DATE]=@RFQ_ACK_DATE,
        [PO_ACK_DATE]=@PO_ACK_DATE,
        [POC_REFERENCE]=@POC_REFERENCE,
        [PODATE]=@PODATE,
        [POC_DATE]=@POC_DATE,
        [POC_BY]=@POC_BY,
        [BUYER_REMARKS]=@BUYER_REMARKS,
        [VESSEL_NAME]=@VESSEL_NAME,
        [VESSEL_IDNO]=@VESSEL_IDNO,
        [VESSEL_OWNER]=@VESSEL_OWNER,
        [VESSEL_OWNER_CODE]=@VESSEL_OWNER_CODE,
        [EXPORTED]=@EXPORTED,
        [VERSION]=@VERSION,
        [RFQ_EXPORT]=@RFQ_EXPORT,
        [QUOTE_FILE_REF]=@QUOTE_FILE_REF,
        [PRINT_STATUS]=@PRINT_STATUS,
        [QUOTE_FILE_STAMP]=@QUOTE_FILE_STAMP,
        [DELIVERY_PROMISED]=@DELIVERY_PROMISED,
        [GENERAL_TERMS]=@GENERAL_TERMS,
        [PAY_TERMS]=@PAY_TERMS,
        [TAX_PERCNT]=@TAX_PERCNT,
        [QUOTE_VERSION]=@QUOTE_VERSION,
        [IS_DECLINED]=@IS_DECLINED,
        [QUOTE_SUBJECT]=@QUOTE_SUBJECT,
        [SP_MAS_REMARK]=@SP_MAS_REMARK,
        [BYR_SUPP_LINKID]=@BYR_SUPP_LINKID,
        [ATTACHMENT1]=@ATTACHMENT1,
        [ATTACHMENT2]=@ATTACHMENT2,
        [ALLOWANCE]=@ALLOWANCE,
        [SALESORDERID]=@SALESORDERID,
        [UDF1]=@UDF1,
        [UDF2]=@UDF2,
        [UDF3]=@UDF3,
        [RevisionNumber]=@RevisionNumber,
        [LINK_RECORDID]=@LINK_RECORDID,
        [TRANSPORT_MODE]=@TRANSPORT_MODE,
        [OrderHandling]=@OrderHandling,
        [OrderType]=@OrderType,
        [OriginatingRequestNo]=@OriginatingRequestNo,
        [ShipComplete]=@ShipComplete,
        [SupplierORGRef]=@SupplierORGRef,
        [UpdType]=@UpdType,
        [ContractType]=@ContractType,
        [OrgSystemRef]=@OrgSystemRef,
        [OTHER_COST2]=@OTHER_COST2,
        [OTHER_COST3]=@OTHER_COST3,
	[VESSEL_ARRTIME]=@VESSEL_ARRTIME,
	[VESSEL_ETA]=@VESSEL_ETA
WHERE        [QUOTATIONID]=@QUOTATIONID
END




GO




ALTER PROCEDURE [dbo].[sp_LES_SALESORDERDETAILS_SALESORDERID]
(
@SALESORDERID INT
)
AS
BEGIN
SELECT SALESORDERDETAILID,SO.SALESORDERID,
SO.QUOTATIONDETAILID,
SO.DRAWINGNO,
SO.POSNO,
SO.MAKERREF,
SO.ITEMNO,
TOSPLIT,
SO.UDF1,
SO.UDF2,
SO.UDF3,
ISNULL(SO.REFNO,'') AS 'REFNO',	
SO.PARTNAME,
SM_QUOTATIONDETAIL_VENDOR.BUYER_UNIT_CODE,	
SO.UNIT_CODE,
ORDERED_QTY,QTY,
BUYER_STATUS,
ISNULL(BUYER_UNITPRICE,0) AS BUYER_UNITPRICE,
ISNULL(VENDOR_UNITPRICE,0) AS VENDOR_UNITPRICE,
ISNULL(SO.DISCOUNT,0) AS DISCOUNT,
ISNULL(DELIVERY_DAYS,0) AS DELIVERY_DAYS,
SO.UPDATE_DATE,
SO.CREATED_DATE,
SO.UPDATED_BY,
SO.CREATED_BY,
(ISNULL(SO.PARTNAME,'') + (case when (SO.REFNO IS NOT NULL OR SO.REFNO<>'') 
then ('|Ref. No. :'+SO.REFNO) else '' end)+	(case when (SO.DRAWINGNO is not null or SO.DRAWINGNO <> '') 
then ('|Drawing No.:'+ SO.DRAWINGNO) else '' end))	AS DISPLAY_PARTNAME,
ITEM_REMARKS,SO.APPROVED_VENDORID 
FROM LES_SALESORDER_DETAILS SO
left join SM_QUOTATIONDETAIL_VENDOR ON SO.QUOTATIONDETAILID=SM_QUOTATIONDETAIL_VENDOR.QUOTATIONDETAILID
WHERE SALESORDERID= @SALESORDERID

END

GO

ALTER PROC [dbo].[sp_LES_SALESORDERDETAILS_APPROVED]
(
@SALESORDERID INT
)
AS
BEGIN
SELECT * FROM LES_SALESORDER_DETAILS 
WHERE APPROVED_VENDORID IS NOT NULL 
AND SALESORDERID = @SALESORDERID
END

GO


Create Procedure [dbo].[sp_SM_QUOTATIONDETAIL_BUYER_Update]
(
@QUOTATIONDETAILID int,
@QUOTATIONID int,
@ITEMSTATUS int,
@ITEMNO int,
@VENDOR_ITEMNO nvarchar(20),
@QTY_REQ float,
@QTY_QUOTED float,
@QTY_ORD float,
@QUOTED_PRICE float,
@QUOTE_EXCHRATE float,
@DISCOUNT float,
@DELIVERYTIME int,
@PARTNAME nvarchar(1000),
@DRAWINGNO nvarchar(200),
@POSNO nvarchar(200),
@REFNO nvarchar(200),
@UNIT_CODE nvarchar(15),
@EQUIP_NAME nvarchar(200),
@EQUIP_MAKER nvarchar(512),
@EQUIP_TYPE nvarchar(200),
@EQUIP_SERNO nvarchar(200),
@EQUIP_REMARKS nvarchar(1000),
@QUOTEITEM_REMARK  ntext,
@ITEM_REMARK nvarchar(2048),
@UPDATE_DATE datetime,
@CREATED_DATE datetime,
@CHANGED_BY_VENDOR int,
@SITEID int,
@DOCITEMID nvarchar(256),
@QUOTE_FILE nvarchar(50),
@VENDOR_REFNO nvarchar(50),
@ORIGINATINGSYSTEMREF nvarchar(50),
@ITEM_MARKED_REMARK nvarchar(max),
@SYS_ITEMNO int,
@BUYER_UNIT_CODE nvarchar(15),
@ITEM_TYPE nvarchar(20),
@LINK_RECORD_ID int,
@UDF1 nvarchar(50),
@UDF2 nvarchar(50),
@UDF3 nvarchar(50),
@SupplierORGRef nvarchar(20),
@SALESORDERID int,
@SALESORDERITEMID int,
@VENDOR_ITEMNAME nvarchar(500),
@BuyerORGRef nvarchar(40)
)
AS
BEGIN
    UPDATE [dbo].[SM_QUOTATIONDETAIL_BUYER]
    SET
        [QUOTATIONID]=@QUOTATIONID,
        [ITEMSTATUS]=@ITEMSTATUS,
        [ITEMNO]=@ITEMNO,
        [VENDOR_ITEMNO]=@VENDOR_ITEMNO,
        [QTY_REQ]=@QTY_REQ,
        [QTY_QUOTED]=@QTY_QUOTED,
        [QTY_ORD]=@QTY_ORD,
        [QUOTED_PRICE]=@QUOTED_PRICE,
        [QUOTE_EXCHRATE]=@QUOTE_EXCHRATE,
        [DISCOUNT]=@DISCOUNT,
        [DELIVERYTIME]=@DELIVERYTIME,
        [PARTNAME]=@PARTNAME,
        [DRAWINGNO]=@DRAWINGNO,
        [POSNO]=@POSNO,
        [REFNO]=@REFNO,
        [UNIT_CODE]=@UNIT_CODE,
        [EQUIP_NAME]=@EQUIP_NAME,
        [EQUIP_MAKER]=@EQUIP_MAKER,
        [EQUIP_TYPE]=@EQUIP_TYPE,
        [EQUIP_SERNO]=@EQUIP_SERNO,
        [EQUIP_REMARKS]=@EQUIP_REMARKS,
        [QUOTEITEM_REMARK]=@QUOTEITEM_REMARK,
        [ITEM_REMARK]=@ITEM_REMARK,
        [UPDATE_DATE]=@UPDATE_DATE,
        [CREATED_DATE]=@CREATED_DATE,
        [CHANGED_BY_VENDOR]=@CHANGED_BY_VENDOR,
        [SITEID]=@SITEID,
        [DOCITEMID]=@DOCITEMID,
        [QUOTE_FILE]=@QUOTE_FILE,
        [VENDOR_REFNO]=@VENDOR_REFNO,
        [ORIGINATINGSYSTEMREF]=@ORIGINATINGSYSTEMREF,
        [ITEM_MARKED_REMARK]=@ITEM_MARKED_REMARK,
        [SYS_ITEMNO]=@SYS_ITEMNO,
        [BUYER_UNIT_CODE]=@BUYER_UNIT_CODE,
        [ITEM_TYPE]=@ITEM_TYPE,
        [LINK_RECORD_ID]=@LINK_RECORD_ID,
        [UDF1]=@UDF1,
        [UDF2]=@UDF2,
        [UDF3]=@UDF3,
        [SupplierORGRef]=@SupplierORGRef,
        [SALESORDERID]=@SALESORDERID,
        [SALESORDERITEMID]=@SALESORDERITEMID,
        [VENDOR_ITEMNAME]=@VENDOR_ITEMNAME,
        [BuyerORGRef]=@BuyerORGRef
WHERE        [QUOTATIONDETAILID]=@QUOTATIONDETAILID
END




GO


ALTER TRIGGER [dbo].[trgAfterInsertDocReferenceMTML] ON [dbo].[MTML_DOC_REFERENCE] 
FOR INSERT
AS
	declare @docId nvarchar(256);
	declare @REFERENCENUMBER nvarchar(30);
	declare @Qualifier nvarchar(5);
    declare @Vendor_status int;
	
	select @docId=i.MTMLDOCID,@REFERENCENUMBER=i.REFERENCENUMBER,@Qualifier=i.QUALIFIER from inserted i;
	select @Vendor_status=ISNULL(VENDOR_STATUS,0) from SM_QUOTATIONS_VENDOR where DOCID=@docId;

	if LEN(@REFERENCENUMBER) > 0
	Begin
		IF (@Qualifier = 'AAG')  
		begin
			if (@Vendor_status = 6)
				update [dbo].[SM_QUOTATIONS_VENDOR] set POC_REFERENCE=@REFERENCENUMBER where DOCID=@docId;
			else
				update [dbo].[SM_QUOTATIONS_VENDOR] set QUOTE_REFERENCE=@REFERENCENUMBER where DOCID=@docId;
		end
	END;





ALTER PROCEDURE [dbo].[select_SM_TOP_TRANSACTIONS_S]
(
@ADDRESSID int
)
AS
BEGIN
SELECT TOP (500) QUOTATIONID,VRNO,BUYER_CODE,BUYER_NAME,SUPPLIER_CODE,SUPPLIER_NAME,
DOC_TYPE,
RIGHT('0'+CAST(DATEPART(D,CREATED_DATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,CREATED_DATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,CREATED_DATE) AS VARCHAR) AS RFQ_RECEIVED_DATE, 
CASE WHEN UPPER(DOC_TYPE) IN ('QUOTE','QUOTATION','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,RFQ_ACK_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,RFQ_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,RFQ_ACK_DATE) AS VARCHAR) END AS RFQ_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE RIGHT('0'+CAST(DATEPART(D,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,QUOTE_RECVD_DATE) AS VARCHAR),2)
+'/'+CAST(DATEPART(YYYY,QUOTE_RECVD_DATE) AS VARCHAR) END AS QUOTE_RECVD_DATE,
FREIGHTAMT,QUOTE_AMOUNT,OTHERCOSTS,
--CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
--THEN NULL ELSE FREIGHTAMT END AS FREIGHTAMT,
--CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
--THEN NULL ELSE QUOTE_AMOUNT END AS QUOTE_AMOUNT,
--CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
--THEN NULL ELSE OTHERCOSTS END AS OTHERCOSTS,
CURR_CODE,   
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDER','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE   RIGHT('0'+CAST(DATEPART(D,QUOTE_VALIDITY) AS VARCHAR),2)
+'/'+RIGHT('0'+CAST(DATEPART(M,QUOTE_VALIDITY) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,QUOTE_VALIDITY) AS VARCHAR) END AS QUOTE_VALIDITY, 
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE QUOTE_REFERENCE END AS QUOTE_REFERENCE, 		 
RIGHT('0'+CAST(DATEPART(D,PODATE) AS VARCHAR),2) 
+'/'+RIGHT('0'+CAST(DATEPART(M,PODATE) AS VARCHAR),2) +'/'+CAST(DATEPART(YYYY,PODATE) AS VARCHAR) AS PODATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDERCONFIRMATION','OrderResponse','POC') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,PO_ACK_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,PO_ACK_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,PO_ACK_DATE) AS VARCHAR) END AS PO_ACK_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  RIGHT('0'+CAST(DATEPART(D,POC_DATE) AS VARCHAR),2) +'/'+RIGHT('0'+CAST(DATEPART(M,POC_DATE) AS VARCHAR),2) 
+'/'+CAST(DATEPART(YYYY,POC_DATE) AS VARCHAR) END AS POC_DATE,
CASE WHEN UPPER(DOC_TYPE) IN ('REQUESTFORQUOTE','QUOTE','QUOTATION','ORDER') 
THEN NULL ELSE  POC_REFERENCE END AS POC_REFERENCE,PORT_NAME,VESSEL_NAME, VESSEL_IDNO,QUOTE_ADDRESSID,BUYER_ADDRESSID,UPDATE_DATE
FROM SM_QUOTATIONS_VENDOR  
INNER JOIN SMV_BUYER_SUPPLIER_LINK ON SM_QUOTATIONS_VENDOR.BYR_SUPP_LINKID=SMV_BUYER_SUPPLIER_LINK.LINKID
WHERE  YEAR(SM_QUOTATIONS_VENDOR.UPDATE_DATE)= YEAR(GETDATE())
AND QUOTE_ADDRESSID=@ADDRESSID
ORDER BY UPDATE_DATE DESC
END




GO

create Procedure [dbo].[sp_Select_LES_INVENTORY_By_REFNO]
(
@MAKERREF NVARCHAR(50)
)
AS
BEGIN
    SELECT * 
    FROM [dbo].[LES_INVENTORY]
    WHERE
        [MAKERREF]=@MAKERREF
END



